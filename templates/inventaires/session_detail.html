{% extends "base_modern_complete.html" %}
{% block title %}Session d'Inventaire #{{ session.id }} - Import Profit Pro{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-lg);
  }
  
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }
  
  .info-item {
    padding: var(--space-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
  }
  
  .info-label {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: var(--space-xs);
    font-weight: 600;
  }
  
  .info-value {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .variance-positive {
    color: var(--color-success);
    font-weight: 700;
  }
  
  .variance-negative {
    color: var(--color-danger);
    font-weight: 700;
  }
  
  .variance-zero {
    color: var(--text-muted);
  }
  
  /* Tri de tableau */
  .sortable th {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 30px;
  }
  
  .sortable th:hover {
    background-color: var(--gray-100);
  }
  
  .sortable th::after {
    content: ' ↕';
    position: absolute;
    right: 8px;
    opacity: 0.3;
    font-size: 0.875rem;
  }
  
  .sortable th.sort-asc::after {
    content: ' ↑';
    opacity: 1;
    color: var(--color-primary);
  }
  
  .sortable th.sort-desc::after {
    content: ' ↓';
    opacity: 1;
    color: var(--color-primary);
  }
  
  /* Indicateurs de chargement */
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }
  
  .loading-overlay.show {
    display: flex;
  }
  
  .loading-spinner {
    background: white;
    padding: var(--space-xl);
    border-radius: var(--radius-lg);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    text-align: center;
  }
  
  .spinner {
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--color-primary);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-md);
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Tableau responsive */
  .table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: var(--space-lg);
  }
  
  .table-hl {
    min-width: 100%;
    width: 100%;
  }
  
  .table-hl table {
    min-width: 800px;
  }
  
  /* Actions responsive */
  .actions-mobile {
    display: none;
  }
  
  /* Formulaire de filtres */
  .filters-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: var(--space-md);
    width: 100%;
    box-sizing: border-box;
  }
  
  .filters-form .form-group {
    min-width: 0;
    width: 100%;
  }
  
  .filters-form .form-group input,
  .filters-form .form-group select {
    width: 100%;
    box-sizing: border-box;
  }
  
  .filters-actions {
    display: flex;
    gap: var(--space-sm);
    align-items: flex-end;
    flex-wrap: wrap;
  }
  
  .filters-actions .btn-hl {
    flex: 1;
    min-width: 120px;
    white-space: nowrap;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .page-container {
      padding: 0 var(--space-md);
    }
    
    .info-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-sm);
    }
    
    .info-item {
      padding: var(--space-sm);
    }
    
    .info-value {
      font-size: 1rem;
    }
    
    /* Statistiques détaillées */
    .card-hl > div[style*="grid-template-columns"] {
      grid-template-columns: 1fr !important;
      gap: var(--space-sm) !important;
    }
    
    /* Graphiques */
    .card-hl > div[style*="grid-template-columns: repeat(auto-fit"] {
      grid-template-columns: 1fr !important;
    }
    
    .card-hl > div[style*="grid-template-columns: repeat(auto-fit"] > div {
      height: 250px !important;
    }
    
    /* Boutons d'action */
    div[style*="display: flex"][style*="gap: var(--space-md)"] {
      flex-direction: column;
    }
    
    div[style*="display: flex"][style*="gap: var(--space-md)"] > * {
      width: 100%;
    }
    
    /* Formulaire de filtres */
    .filters-form {
      grid-template-columns: 1fr !important;
    }
    
    .filters-actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    .filters-actions .btn-hl {
      width: 100%;
      min-width: auto;
    }
    
    /* Tableau - masquer certaines colonnes sur mobile */
    .table-hl table thead th:nth-child(6),
    .table-hl table tbody td:nth-child(6),
    .table-hl table thead th:nth-child(7),
    .table-hl table tbody td:nth-child(7),
    .table-hl table thead th:nth-child(8),
    .table-hl table tbody td:nth-child(8) {
      display: none;
    }
    
    /* Actions dans le tableau */
    .table-hl table thead th:last-child,
    .table-hl table tbody td:last-child {
      position: sticky;
      right: 0;
      background: var(--bg-primary);
      z-index: 10;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }
    
    /* Pagination */
    div[style*="justify-content: center"][style*="flex-wrap: wrap"] {
      flex-direction: column;
      align-items: stretch;
    }
    
    div[style*="justify-content: center"][style*="flex-wrap: wrap"] > * {
      width: 100%;
      text-align: center;
    }
    
    /* Titres */
    h3 {
      font-size: 1.1rem !important;
    }
    
    .page-title-hl {
      font-size: 1.5rem !important;
    }
  }
  
  @media (max-width: 480px) {
    .page-container {
      padding: 0 var(--space-sm);
    }
    
    .info-grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xs);
    }
    
    .info-item {
      padding: var(--space-xs);
    }
    
    .info-label {
      font-size: 0.75rem;
    }
    
    .info-value {
      font-size: 0.9rem;
    }
    
    /* Masquer plus de colonnes sur très petit écran */
    .table-hl table thead th:nth-child(3),
    .table-hl table tbody td:nth-child(3),
    .table-hl table thead th:nth-child(4),
    .table-hl table tbody td:nth-child(4) {
      display: none;
    }
    
    /* Statistiques avec texte plus petit */
    .card-hl > div[style*="grid-template-columns"] > div {
      padding: var(--space-sm) !important;
    }
    
    .card-hl > div[style*="grid-template-columns"] > div > div[style*="font-size: 2rem"] {
      font-size: 1.5rem !important;
    }
  }
  
  /* Amélioration pour tablettes */
  @media (min-width: 769px) and (max-width: 1024px) {
    .info-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    
    .table-hl table {
      min-width: 900px;
    }
    
    .charts-container {
      grid-template-columns: 1fr !important;
    }
  }
  
  /* Styles pour les cartes de statistiques */
  .stats-cards > div {
    transition: transform 0.2s ease;
  }
  
  .stats-cards > div:hover {
    transform: translateY(-2px);
  }
  
  @media (max-width: 768px) {
    .stats-cards {
      grid-template-columns: 1fr !important;
    }
    
    .charts-container {
      grid-template-columns: 1fr !important;
    }
    
    .charts-container > div {
      height: 250px !important;
    }
  }
  
  @media (max-width: 480px) {
    .stats-cards > div {
      padding: var(--space-sm) !important;
    }
    
    .stats-cards > div > div[style*="font-size: 2rem"] {
      font-size: 1.5rem !important;
    }
    
    .stats-cards > div > i {
      font-size: 1.2rem !important;
    }
    
    .charts-container > div {
      height: 200px !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
  <div class="card-hl">
    <div class="page-header-hl" style="border-bottom: 2px solid var(--gray-200); padding-bottom: var(--space-lg); margin-bottom: var(--space-xl);">
      <h1 class="page-title-hl">
        <i class="fas fa-clipboard-check me-2"></i>
        Session d'Inventaire #{{ session.id }}
      </h1>
    </div>

    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">Date</div>
        <div class="info-value">{{ session.session_date.strftime('%d/%m/%Y %H:%M') if session.session_date else '-' }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Dépôt</div>
        <div class="info-value">{{ session.depot.name if session.depot else '-' }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Opérateur</div>
        <div class="info-value">{{ session.operator.username if session.operator else '-' }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Statut</div>
        <div class="info-value">
          <span class="badge-hl {% if session.status == 'validated' %}badge-hl-success{% elif session.status == 'completed' %}badge-hl-success{% elif session.status == 'in_progress' %}badge-hl-warning{% else %}badge-hl-warning{% endif %}">
            {{ session.status|replace('_', ' ')|title }}
          </span>
        </div>
      </div>
      <div class="info-item">
        <div class="info-label">Articles</div>
        <div class="info-value">{{ total_items }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Écarts totaux</div>
        <div class="info-value">{{ total_variances|format_number(2) }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Valeur écarts</div>
        <div class="info-value" style="color: {% if total_value_variances == 0 %}#10b981{% elif total_value_variances > 0 %}#ef4444{% else %}#ea580c{% endif %};">
          {{ total_value_variances|format_number(0) }} GNF
        </div>
      </div>
      <div class="info-item">
        <div class="info-label">Précision</div>
        <div class="info-value" style="color: {% if precision_pct >= 95 %}#10b981{% elif precision_pct >= 80 %}#f59e0b{% else %}#ef4444{% endif %};">
          {{ "{:.1f}".format(precision_pct) }}%
        </div>
      </div>
    </div>
    
    <!-- Statistiques détaillées -->
    <div class="card-hl" style="margin-bottom: var(--space-xl);">
      <h3 style="color: var(--text-primary); margin-bottom: var(--space-md); font-size: 1.2rem; font-weight: 600;">
        <i class="fas fa-chart-bar me-2" style="color: var(--color-primary);"></i>
        Répartition des Écarts
      </h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-md);" class="stats-cards">
        <div style="text-align: center; padding: var(--space-md); background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: var(--radius-md); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <i class="fas fa-arrow-up" style="font-size: 1.5rem; margin-bottom: var(--space-xs); opacity: 0.9;"></i>
          <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--space-xs);">{{ positive_count }}</div>
          <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: var(--space-xs);">Surplus</div>
          <div style="font-size: 0.75rem; opacity: 0.8;">+{{ "{:.2f}".format(positive_total) }}</div>
        </div>
        <div style="text-align: center; padding: var(--space-md); background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: var(--radius-md); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <i class="fas fa-arrow-down" style="font-size: 1.5rem; margin-bottom: var(--space-xs); opacity: 0.9;"></i>
          <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--space-xs);">{{ negative_count }}</div>
          <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: var(--space-xs);">Manquants</div>
          <div style="font-size: 0.75rem; opacity: 0.8;">{{ "{:.2f}".format(negative_total) }}</div>
        </div>
        <div style="text-align: center; padding: var(--space-md); background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); border-radius: var(--radius-md); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <i class="fas fa-equals" style="font-size: 1.5rem; margin-bottom: var(--space-xs); opacity: 0.9;"></i>
          <div style="font-size: 2rem; font-weight: 700; margin-bottom: var(--space-xs);">{{ zero_count }}</div>
          <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: var(--space-xs);">Conformes</div>
          <div style="font-size: 0.75rem; opacity: 0.8;">0.00</div>
        </div>
      </div>
    </div>
    
    <!-- Graphique de répartition -->
    {% if total_items > 0 %}
    <div class="card-hl" style="margin-bottom: var(--space-xl);">
      <h3 style="color: var(--text-primary); margin-bottom: var(--space-md); font-size: 1.2rem; font-weight: 600;">
        <i class="fas fa-chart-pie me-2" style="color: var(--color-primary);"></i>
        Visualisation des Écarts
      </h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-lg);" class="charts-container">
        <div style="position: relative; height: 300px; min-height: 250px;">
          <canvas id="varianceChart"></canvas>
        </div>
        <div style="position: relative; height: 300px; min-height: 250px;">
          <canvas id="varianceBarChart"></canvas>
        </div>
      </div>
    </div>
    
    <script>
      // Graphique en camembert
      const varianceCtx = document.getElementById('varianceChart').getContext('2d');
      new Chart(varianceCtx, {
        type: 'doughnut',
        data: {
          labels: ['Surplus', 'Manquants', 'Conformes'],
          datasets: [{
            data: [{{ positive_count }}, {{ negative_count }}, {{ zero_count }}],
            backgroundColor: ['#10b981', '#ef4444', '#6b7280'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
                font: { size: 12 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = {{ total_items }};
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // Graphique en barres (top 10 écarts)
      const topVariances = [
        {% for item in details_with_value[:10] %}
        {% set detail = item.detail %}
        {
          article: {{ (detail.stock_item.name if detail.stock_item else 'N/A')|tojson }},
          variance: {{ detail.variance|float }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];
      
      const varianceBarCtx = document.getElementById('varianceBarChart').getContext('2d');
      new Chart(varianceBarCtx, {
        type: 'bar',
        data: {
          labels: topVariances.map(d => d.article.length > 20 ? d.article.substring(0, 20) + '...' : d.article),
          datasets: [{
            label: 'Écarts',
            data: topVariances.map(d => d.variance),
            backgroundColor: topVariances.map(d => d.variance == 0 ? '#10b981' : d.variance > 0 ? '#ef4444' : '#ea580c'),
            borderColor: topVariances.map(d => d.variance == 0 ? '#059669' : d.variance > 0 ? '#dc2626' : '#c2410c'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    </script>
    {% endif %}

    <!-- Overlay de chargement -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <div style="font-weight: 600; color: var(--text-primary);" id="loadingText">Traitement en cours...</div>
      </div>
    </div>

    <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-xl); flex-wrap: wrap;">
      {% if session.status != 'validated' %}
      <a href="{{ url_for('inventaires.session_detail_add', id=session.id) }}" class="btn-hl btn-hl-primary">
        <i class="fas fa-plus me-2"></i>Ajouter un Article
      </a>
      {% if session.status == 'completed' and has_permission(current_user, 'inventory.validate') %}
      <form method="POST" action="{{ url_for('inventaires.session_validate', id=session.id) }}" style="display: inline;" id="validateForm">
        <button type="submit" class="btn-hl btn-hl-accent" onclick="return showValidateConfirmation(event);">
          <i class="fas fa-check-circle me-2"></i>Valider la Session
        </button>
      </form>
      {% elif session.status != 'completed' %}
      <form method="POST" action="{{ url_for('inventaires.session_complete', id=session.id) }}" style="display: inline;" id="completeForm">
        <button type="submit" class="btn-hl btn-hl-primary" onclick="showLoading('Marquage en cours...');">
          <i class="fas fa-check me-2"></i>Marquer comme Complétée
        </button>
      </form>
      {% endif %}
      {% endif %}
      {% if session.details and has_permission(current_user, 'inventory.read') %}
      <a href="{{ url_for('inventaires.session_export_excel', id=session.id) }}" class="btn-hl btn-hl-success" onclick="showLoading('Export Excel en cours...');">
        <i class="fas fa-file-excel me-2"></i>Exporter Excel
      </a>
      {% endif %}
    </div>

    <!-- Filtres et recherche -->
    {% if session.details %}
    <div class="card-hl" style="margin-bottom: var(--space-md);">
      <h3 style="color: var(--text-primary); margin-bottom: var(--space-md); font-size: 1.1rem;">
        <i class="fas fa-filter me-2"></i>
        Filtres et Recherche
      </h3>
      <form method="GET" action="{{ url_for('inventaires.session_detail', id=session.id) }}" class="filters-form">
        <div class="form-group">
          <label class="form-hl-label">Recherche</label>
          <input type="text" name="search" value="{{ search or '' }}" class="form-hl-input" placeholder="SKU ou nom d'article...">
        </div>
        <div class="form-group">
          <label class="form-hl-label">Type d'écart</label>
          <select name="variance_filter" class="form-hl-select">
            <option value="">Tous les écarts</option>
            <option value="positive" {% if variance_filter == 'positive' %}selected{% endif %}>Manquants uniquement (rouge)</option>
            <option value="negative" {% if variance_filter == 'negative' %}selected{% endif %}>Surplus uniquement (orange)</option>
            <option value="zero" {% if variance_filter == 'zero' %}selected{% endif %}>Conformes uniquement (vert)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-hl-label">Par page</label>
          <select name="per_page" class="form-hl-select" onchange="this.form.submit()">
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
          </select>
        </div>
        <div class="form-group filters-actions">
          <button type="submit" class="btn-hl btn-hl-primary">
            <i class="fas fa-search me-2"></i>Rechercher
          </button>
          <a href="{{ url_for('inventaires.session_detail', id=session.id) }}" class="btn-hl btn-hl-secondary">
            <i class="fas fa-times me-2"></i>Réinitialiser
          </a>
        </div>
      </form>
    </div>
    
    <h3 style="color: var(--text-primary); margin-bottom: var(--space-md); font-size: 1.25rem;">
      Détails de l'inventaire
      {% if pagination %}
      <span style="font-size: 0.875rem; font-weight: normal; color: var(--text-secondary);">
        ({{ pagination.total }} article{{ 's' if pagination.total > 1 else '' }})
      </span>
      {% endif %}
    </h3>
    <div class="table-wrapper">
      <div class="table-hl">
        <table style="width: 100%;" class="sortable" id="detailsTable">
        <thead>
          <tr>
            <th data-sort="sku">SKU</th>
            <th data-sort="article">Article</th>
            <th data-sort="system_qty" data-sort-type="number">Quantité Système</th>
            <th data-sort="counted_qty" data-sort-type="number">Quantité Comptée</th>
            <th data-sort="variance" data-sort-type="number">Écart</th>
            <th data-sort="value_variance" data-sort-type="number">Valeur Écart (GNF)</th>
            <th data-sort="pile">Pile</th>
            <th data-sort="reason">Raison</th>
            {% if session.status != 'validated' %}
            <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for item in details_with_value %}
          {% set detail = item.detail %}
          <tr>
            <td data-sort-value="{{ detail.stock_item.sku if detail.stock_item else '' }}"><strong>{{ detail.stock_item.sku if detail.stock_item else '-' }}</strong></td>
            <td data-sort-value="{{ detail.stock_item.name if detail.stock_item else '' }}">{{ detail.stock_item.name if detail.stock_item else '-' }}</td>
            <td data-sort-value="{{ detail.system_quantity }}">{{ "{:.2f}".format(detail.system_quantity) }}</td>
            <td data-sort-value="{{ detail.counted_quantity }}">{{ "{:.2f}".format(detail.counted_quantity) }}</td>
            <td data-sort-value="{{ detail.variance }}">
              <span style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; border-radius: var(--radius-md); font-weight: 700; font-size: 0.875rem; {% if detail.variance == 0 %}background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #10b981;{% elif detail.variance > 0 %}background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #ef4444;{% else %}background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); color: #ea580c;{% endif %}">
                {% if detail.variance == 0 %}<i class="fas fa-check-circle"></i>{% elif detail.variance > 0 %}<i class="fas fa-exclamation-triangle"></i>{% else %}<i class="fas fa-plus-circle"></i>{% endif %}
                {{ "{:+.2f}".format(detail.variance) }}
              </span>
            </td>
            <td data-sort-value="{{ item.value_variance }}">
              {% if item.has_price %}
              <span style="color: {% if detail.variance == 0 %}#10b981{% elif detail.variance > 0 %}#ef4444{% else %}#ea580c{% endif %}; font-weight: 600;">
                {{ item.value_variance|format_number(0) }} GNF
              </span>
              {% else %}
              <span style="color: var(--text-muted);">-</span>
              {% endif %}
            </td>
            <td data-sort-value="{{ detail.pile_dimensions or '' }}">{{ detail.pile_dimensions or '-' }}</td>
            <td data-sort-value="{{ detail.reason or '' }}">{{ detail.reason or '-' }}</td>
            {% if session.status != 'validated' %}
            <td>
              <div style="display: flex; gap: var(--space-xs);">
                <a href="{{ url_for('inventaires.session_detail_edit', id=session.id, detail_id=detail.id) }}" 
                   class="btn-hl btn-hl-outline" 
                   style="padding: var(--space-xs) var(--space-sm);" 
                   title="Modifier">
                  <i class="fas fa-edit"></i>
                </a>
                <form method="POST" 
                      action="{{ url_for('inventaires.session_detail_delete', id=session.id, detail_id=detail.id) }}" 
                      style="display: inline;"
                      onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce détail d\'inventaire ?');">
                  <button type="submit" 
                          class="btn-hl btn-hl-outline" 
                          style="padding: var(--space-xs) var(--space-sm); color: var(--color-danger);" 
                          title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
    
    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    <div style="display: flex; justify-content: center; align-items: center; gap: var(--space-md); margin-top: var(--space-xl); padding-top: var(--space-xl); border-top: 1px solid var(--gray-200); flex-wrap: wrap;">
      {% if pagination.has_prev %}
      <a href="{{ url_for('inventaires.session_detail', id=session.id, page=pagination.prev_num, search=search, variance_filter=variance_filter, per_page=per_page) }}" 
         class="btn-hl btn-hl-secondary">
        <i class="fas fa-chevron-left me-2"></i>Précédent
      </a>
      {% endif %}
      
      <span style="color: var(--text-secondary); font-weight: 500; padding: var(--space-sm);">
        Page {{ pagination.page }} sur {{ pagination.pages }} 
        ({{ pagination.total }} article{{ 's' if pagination.total > 1 else '' }})
      </span>
      
      {% if pagination.has_next %}
      <a href="{{ url_for('inventaires.session_detail', id=session.id, page=pagination.next_num, search=search, variance_filter=variance_filter, per_page=per_page) }}" 
         class="btn-hl btn-hl-secondary">
        Suivant<i class="fas fa-chevron-right ms-2"></i>
      </a>
      {% endif %}
    </div>
    
    <!-- Liens de pagination rapide -->
    <div style="display: flex; justify-content: center; gap: var(--space-xs); margin-top: var(--space-md); flex-wrap: wrap;">
      {% for page_num in range(1, pagination.pages + 1) %}
        {% if page_num == pagination.page %}
        <span class="btn-hl btn-hl-primary" style="min-width: 40px; text-align: center;">{{ page_num }}</span>
        {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
        <a href="{{ url_for('inventaires.session_detail', id=session.id, page=page_num, search=search, variance_filter=variance_filter, per_page=per_page) }}" 
           class="btn-hl btn-hl-secondary" style="min-width: 40px; text-align: center;">{{ page_num }}</a>
        {% elif page_num == 4 or page_num == pagination.pages - 3 %}
        <span style="color: var(--text-muted); padding: var(--space-xs);">...</span>
        {% endif %}
      {% endfor %}
    </div>
    {% endif %}
    {% endif %}

    <div style="margin-top: var(--space-xl);">
      <a href="{{ url_for('inventaires.sessions_list') }}" class="btn-hl btn-hl-outline">
        <i class="fas fa-arrow-left me-2"></i>
        Retour à la liste
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fonctions pour les indicateurs de chargement
function showLoading(text) {
  const overlay = document.getElementById('loadingOverlay');
  const loadingText = document.getElementById('loadingText');
  if (overlay && loadingText) {
    loadingText.textContent = text || 'Traitement en cours...';
    overlay.classList.add('show');
  }
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
}

// Confirmation améliorée pour la validation
function showValidateConfirmation(event) {
  event.preventDefault();
  
  const positiveCount = {{ positive_count }};
  const negativeCount = {{ negative_count }};
  const totalValueVariance = {{ total_value_variances|abs }};
  const totalItems = {{ total_items }};
  
  let message = 'Valider cette session générera des ajustements de stock.\n\n';
  message += `Résumé de la session :\n`;
  message += `- Total articles : ${totalItems}\n`;
  message += `- Surplus : ${positiveCount} article(s)\n`;
  message += `- Manquants : ${negativeCount} article(s)\n`;
  if (totalValueVariance > 0) {
    message += `- Valeur totale des écarts : ${totalValueVariance.toLocaleString('fr-FR')} GNF\n`;
  }
  message += `\nÊtes-vous sûr de vouloir continuer ?`;
  
  if (confirm(message)) {
    showLoading('Validation en cours...');
    document.getElementById('validateForm').submit();
    return true;
  }
  return false;
}

// Gestion du chargement pour les liens d'export
document.addEventListener('DOMContentLoaded', function() {
  const exportLink = document.querySelector('a[href*="export/excel"]');
  if (exportLink) {
    exportLink.addEventListener('click', function(e) {
      // Le chargement sera géré par le navigateur pour les téléchargements
      // Mais on peut ajouter un délai pour montrer le loader
      setTimeout(function() {
        hideLoading();
      }, 2000);
    });
  }
  
  // Cacher le loader si la page se recharge après une action
  window.addEventListener('load', function() {
    setTimeout(hideLoading, 500);
  });
});

// Fonction de tri pour le tableau
document.addEventListener('DOMContentLoaded', function() {
  const table = document.getElementById('detailsTable');
  if (!table) return;
  
  const headers = table.querySelectorAll('th[data-sort]');
  let currentSort = { column: null, direction: 'asc' };
  
  headers.forEach((header, index) => {
    header.addEventListener('click', function() {
      const sortType = this.getAttribute('data-sort-type') || 'text';
      const sortKey = this.getAttribute('data-sort');
      
      // Déterminer la direction du tri
      if (currentSort.column === sortKey) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.direction = 'asc';
      }
      currentSort.column = sortKey;
      
      // Retirer toutes les classes de tri
      headers.forEach(h => {
        h.classList.remove('sort-asc', 'sort-desc');
      });
      
      // Ajouter la classe appropriée
      this.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
      
      // Trier les lignes
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      rows.sort((a, b) => {
        const aCell = a.querySelector(`td:nth-child(${index + 1})`);
        const bCell = b.querySelector(`td:nth-child(${index + 1})`);
        
        if (!aCell || !bCell) return 0;
        
        let aValue = aCell.getAttribute('data-sort-value') || aCell.textContent.trim();
        let bValue = bCell.getAttribute('data-sort-value') || bCell.textContent.trim();
        
        if (sortType === 'number') {
          aValue = parseFloat(aValue) || 0;
          bValue = parseFloat(bValue) || 0;
        } else {
          aValue = aValue.toLowerCase();
          bValue = bValue.toLowerCase();
        }
        
        if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
      
      // Réorganiser les lignes dans le DOM
      rows.forEach(row => tbody.appendChild(row));
    });
  });
});
</script>
{% endblock %}
