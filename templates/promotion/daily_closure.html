{% extends "base_modern_complete.html" %}
{% block title %}Clôture Quotidienne - Import Profit Pro{% endblock %}

{% block content %}
<div class="main-content">
  <div class="page-header-promo">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <h1>
        <i class="fas fa-calendar-check icon-promo"></i>
        Clôture Quotidienne - {{ today.strftime('%d/%m/%Y') }}
      </h1>
      <a href="{{ url_for('promotion.dashboard') }}" class="btn btn-promo" style="background: #6c757d; color: white;">
        <i class="fas fa-arrow-left me-2"></i>Retour au Dashboard
      </a>
    </div>
  </div>

  {% if is_closed %}
  <div class="alert alert-promo alert-promo-success d-flex align-items-center section-spacing" role="alert">
    <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
    <div>
      <strong>✅ Journée Clôturée</strong><br>
      Cette journée a été clôturée le {{ closure.closed_at.strftime('%d/%m/%Y à %H:%M') }} par {{ closure.closed_by.full_name if closure.closed_by else 'N/A' }}.
      {% if closure.notes %}
      <br><small class="text-muted">Notes: {{ closure.notes }}</small>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="alert alert-promo alert-promo-warning d-flex align-items-center section-spacing" role="alert">
    <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
    <div>
      <strong>⚠️ Journée Non Clôturée</strong><br>
      Cette journée n'a pas encore été clôturée. Vous pouvez la clôturer après avoir vérifié toutes les opérations.
    </div>
  </div>
  {% endif %}

  <!-- Résumé des ventes par membre -->
  <div class="card-promo section-spacing">
    <div class="card-promo-header">
      <i class="fas fa-chart-bar me-2"></i>
      Résumé des Ventes par Membre - {{ today.strftime('%d/%m/%Y') }}
    </div>
    {% if members_summary %}
    <div class="table-responsive">
      <table class="table table-promo">
          <thead>
            <tr>
              <th>Membre</th>
              <th>Équipe</th>
              <th>Gamme / Pièce</th>
              <th class="text-center">Enlèvements</th>
              <th class="text-center">Retours</th>
              <th class="text-center"><strong>Net (Vendus)</strong></th>
            </tr>
          </thead>
          <tbody>
            {% for member_id, summary in members_summary.items() %}
              {% set member = summary.member %}
              {% set gammes = summary.gammes %}
              {% set rowspan = gammes|length %}
              {% for gamme_id, data in gammes.items() %}
              <tr>
                {% if loop.first %}
                <td rowspan="{{ rowspan }}" style="vertical-align: middle;">
                  <strong>{{ member.full_name if member else 'N/A' }}</strong>
                  {% if member and member.phone %}
                  <br><small class="text-muted">{{ member.phone }}</small>
                  {% endif %}
                </td>
                <td rowspan="{{ rowspan }}" style="vertical-align: middle;">
                  {% if summary.team %}
                    <span class="badge bg-info">{{ summary.team.name }}</span>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
                {% endif %}
                <td>
                  <strong>{{ data.gamme.name if data.gamme else 'N/A' }}</strong>
                  {% if data.gamme and data.gamme.is_piece %}
                  <br><small class="text-muted">{{ data.gamme.unit_type or 'Pièce' }}</small>
                  {% endif %}
                </td>
                <td class="text-center">
                  <span class="badge badge-promo badge-promo-success">{{ data.enlevements }}</span>
                </td>
                <td class="text-center">
                  <span class="badge badge-promo badge-promo-danger">{{ data.retours }}</span>
                </td>
                <td class="text-center">
                  <strong class="{% if data.net > 0 %}text-success{% elif data.net < 0 %}text-danger{% else %}text-muted{% endif %}">
                    {{ data.net }}
                  </strong>
                </td>
              </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
          <tfoot>
            <tr style="background: linear-gradient(135deg, rgba(0, 56, 101, 0.08) 0%, rgba(0, 90, 159, 0.08) 100%); border-top: 2px solid #003865;">
              <th colspan="3" class="text-end" style="text-align: center;"><strong>TOTAL</strong></th>
              <th class="text-center">
                {% set total_enlevements = 0 %}
                {% set total_retours = 0 %}
                {% for member_id, summary in members_summary.items() %}
                  {% for gamme_id, data in summary.gammes.items() %}
                    {% set total_enlevements = total_enlevements + data.enlevements %}
                    {% set total_retours = total_retours + data.retours %}
                  {% endfor %}
                {% endfor %}
                {{ total_enlevements }}
              </th>
              <th class="text-center">
                {{ total_retours }}
              </th>
              <th class="text-center">
                <strong>{{ total_enlevements - total_retours }}</strong>
              </th>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5" style="padding: 1.5rem;">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <p class="text-muted">Aucune vente enregistrée pour cette journée.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Résumé financier de la journée -->
  <div class="card-promo section-spacing">
    <div class="card-promo-header">
      <i class="fas fa-money-bill-wave me-2"></i>
      Résumé Financier de la Journée - {{ today.strftime('%d/%m/%Y') }}
    </div>
    <div style="padding: 1.5rem;">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card text-center" style="background: linear-gradient(135deg, #28a74515 0%, #20c99715 100%); border: 2px solid #28a745;">
            <div class="card-body">
              <h5 class="card-title text-muted mb-2">
                <i class="fas fa-arrow-up text-success me-2"></i>
                Total Enlèvements
              </h5>
              <h3 class="text-success mb-0">
                {{ "{:,.0f}".format(total_ca_enlevements) }} GNF
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center" style="background: linear-gradient(135deg, #dc354515 0%, #fd7e1415 100%); border: 2px solid #dc3545;">
            <div class="card-body">
              <h5 class="card-title text-muted mb-2">
                <i class="fas fa-arrow-down text-danger me-2"></i>
                Total Retours
              </h5>
              <h3 class="text-danger mb-0">
                {{ "{:,.0f}".format(total_ca_retours) }} GNF
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center" style="background: linear-gradient(135deg, rgba(0, 56, 101, 0.08) 0%, rgba(0, 90, 159, 0.08) 100%); border: 2px solid #003865;">
            <div class="card-body">
              <h5 class="card-title text-muted mb-2">
                <i class="fas fa-calculator text-primary me-2"></i>
                <strong>Vente Nette</strong>
              </h5>
              <h3 class="text-primary mb-0" style="font-weight: bold;">
                {{ "{:,.0f}".format(vente_nette) }} GNF
              </h3>
              <small class="text-muted">
                (Total Enlèvements - Total Retours)
              </small>
            </div>
          </div>
        </div>
      </div>
      <div class="alert alert-promo alert-promo-info mt-3 mb-0">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Formule :</strong> Vente Nette = Total Enlèvements de la journée - Total Retours de la journée
      </div>
    </div>
  </div>

  <!-- Formulaire de clôture -->
  {% if not is_closed %}
  <div class="card-promo">
    <div class="card-promo-header">
      <i class="fas fa-lock me-2"></i>
      Clôturer la Journée
    </div>
    <div style="padding: 1.5rem;">
      <form method="POST" action="{{ url_for('promotion.daily_closure') }}">
        <div class="mb-3">
          <label for="notes" class="form-label">Notes (optionnel)</label>
          <textarea class="form-control" id="notes" name="notes" rows="3" 
                    placeholder="Ajoutez des notes ou commentaires sur cette journée..."></textarea>
        </div>
        <div class="alert alert-promo alert-promo-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Attention :</strong> Une fois la journée clôturée, vous ne pourrez plus modifier les opérations de cette journée.
        </div>
        <div class="d-flex justify-content-end gap-2 flex-wrap">
          <a href="{{ url_for('promotion.dashboard') }}" class="btn btn-promo" style="background: #6c757d; color: white;">
            <i class="fas fa-times me-2"></i>Annuler
          </a>
          <button type="submit" class="btn btn-promo btn-promo-primary">
            <i class="fas fa-check me-2"></i>Clôturer la Journée
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</div>

<style>
.table th {
  background-color: var(--gray-100, #f8f9fa);
  font-weight: 600;
}

.table tfoot th {
  background-color: var(--color-info, #0dcaf0);
  color: white;
}

.badge {
  font-size: 0.9rem;
  padding: 0.4rem 0.7rem;
}
</style>
{% endblock %}

