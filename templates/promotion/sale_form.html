{% extends "base_modern_complete.html" %}
{% block title %}{% if sale %}Modifier{% else %}Nouvelle{% endif %} Vente - Import Profit Pro{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Données des gammes disponibles
  const gammes = [
    {% for gamme in gammes %}
    {
      id: {{ gamme.id }},
      name: "{{ gamme.name }}",
      is_piece: {{ 'true' if gamme.is_piece else 'false' }},
      unit_type: "{{ gamme.unit_type or '' }}",
      unit_description: "{{ gamme.unit_description or '' }}",
      selling_price_gnf: {{ gamme.selling_price_gnf|default(0) }},
      commission_per_unit_gnf: {{ gamme.commission_per_unit_gnf|default(0) }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  
  const saleRowsBody = document.getElementById('saleRowsBody');
  const addSaleRowBtn = document.getElementById('addSaleRowBtn');
  const totalAmountDisplay = document.getElementById('total_amount_display');
  const commissionDisplay = document.getElementById('commission_display');
  let rowCounter = 0;
  
  // Fonction pour calculer les totaux globaux
  function updateGlobalTotals() {
    const rows = saleRowsBody.querySelectorAll('tr');
    let totalAmount = 0;
    let totalCommission = 0;
    
    rows.forEach(row => {
      const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
      const price = parseFloat(row.querySelector('.price-input').value) || 0;
      const commission = parseFloat(row.querySelector('.commission-input').value) || 0;
      
      totalAmount += quantity * price;
      totalCommission += quantity * commission;
      
      // Mettre à jour le total de la ligne
      const rowTotal = row.querySelector('.row-total');
      if (rowTotal) {
        rowTotal.textContent = (quantity * price).toLocaleString('fr-FR') + ' GNF';
      }
    });
    
    if (totalAmountDisplay) {
      totalAmountDisplay.textContent = totalAmount.toLocaleString('fr-FR') + ' GNF';
    }
    if (commissionDisplay) {
      commissionDisplay.textContent = totalCommission.toLocaleString('fr-FR') + ' GNF';
    }
  }
  
  // Fonction pour créer une nouvelle ligne
  function createSaleRow() {
    const row = document.createElement('tr');
    row.id = `sale_row_${rowCounter}`;
    row.innerHTML = `
      <td>
        <select class="form-select gamme-select" name="gamme_id_${rowCounter}" required>
          <option value="">-- Sélectionner --</option>
          ${gammes.map(gamme => `
            <option value="${gamme.id}" 
                    data-price="${gamme.selling_price_gnf}" 
                    data-commission="${gamme.commission_per_unit_gnf}">
              ${gamme.name}${gamme.is_piece ? ` (${gamme.unit_type || 'Pièce'})` : ''} - ${gamme.selling_price_gnf.toLocaleString('fr-FR')} GNF
            </option>
          `).join('')}
        </select>
      </td>
      <td>
        <input type="number" class="form-control quantity-input" name="quantity_${rowCounter}" 
               min="1" step="1" required placeholder="Qty" value="1">
      </td>
      <td>
        <input type="number" class="form-control price-input" name="selling_price_gnf_${rowCounter}" 
               step="0.01" min="0" placeholder="Prix" readonly>
      </td>
      <td>
        <input type="number" class="form-control commission-input" name="commission_per_unit_gnf_${rowCounter}" 
               step="0.01" min="0" placeholder="Commission" readonly>
      </td>
      <td>
        <span class="row-total badge bg-info">0 GNF</span>
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-danger remove-row-btn" title="Supprimer">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    
    saleRowsBody.appendChild(row);
    
    // Event listeners
    const gammeSelect = row.querySelector('.gamme-select');
    const quantityInput = row.querySelector('.quantity-input');
    const priceInput = row.querySelector('.price-input');
    const commissionInput = row.querySelector('.commission-input');
    const removeBtn = row.querySelector('.remove-row-btn');
    
    // Charger les prix quand on sélectionne une gamme
    gammeSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption && selectedOption.value) {
        priceInput.value = selectedOption.getAttribute('data-price') || 0;
        commissionInput.value = selectedOption.getAttribute('data-commission') || 0;
        updateGlobalTotals();
      }
    });
    
    // Mettre à jour les totaux quand on change la quantité
    quantityInput.addEventListener('input', updateGlobalTotals);
    priceInput.addEventListener('input', updateGlobalTotals);
    commissionInput.addEventListener('input', updateGlobalTotals);
    
    // Supprimer la ligne
    removeBtn.addEventListener('click', function() {
      row.remove();
      updateGlobalTotals();
      validateForm();
    });
    
    rowCounter++;
    validateForm();
  }
  
  // Validation du formulaire
  function validateForm() {
    const rows = saleRowsBody.querySelectorAll('tr');
    const hasValidRows = Array.from(rows).some(row => {
      const gammeSelect = row.querySelector('.gamme-select');
      const quantityInput = row.querySelector('.quantity-input');
      return gammeSelect.value && quantityInput.value && parseInt(quantityInput.value) > 0;
    });
    
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.disabled = !hasValidRows;
    }
  }
  
  // Ajouter une ligne
  addSaleRowBtn.addEventListener('click', createSaleRow);
  
  // Validation à la soumission
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Vérifier les champs requis du formulaire principal
      const memberSelect = document.getElementById('member_id');
      const transactionType = document.getElementById('transaction_type');
      const saleDate = document.getElementById('sale_date');
      
      if (!memberSelect || !memberSelect.value) {
        e.preventDefault();
        alert('Veuillez sélectionner un membre.');
        if (memberSelect) memberSelect.focus();
        return false;
      }
      
      if (!transactionType || !transactionType.value) {
        e.preventDefault();
        alert('Veuillez sélectionner un type de transaction.');
        if (transactionType) transactionType.focus();
        return false;
      }
      
      if (!saleDate || !saleDate.value) {
        e.preventDefault();
        alert('Veuillez sélectionner une date.');
        if (saleDate) saleDate.focus();
        return false;
      }
      
      // Vérifier les lignes de vente
      const rows = saleRowsBody.querySelectorAll('tr');
      let validRows = [];
      let hasErrors = false;
      
      rows.forEach((row, index) => {
        const gammeSelect = row.querySelector('.gamme-select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.price-input');
        const commissionInput = row.querySelector('.commission-input');
        
        // Supprimer les lignes vides
        if (!gammeSelect || !gammeSelect.value || !quantityInput || !quantityInput.value || parseInt(quantityInput.value) <= 0) {
          row.remove();
          return;
        }
        
        // Vérifier que les prix sont remplis
        if (!priceInput || !priceInput.value || parseFloat(priceInput.value) <= 0) {
          alert(`La ligne ${index + 1} n'a pas de prix valide. Veuillez sélectionner une gamme.`);
          hasErrors = true;
          if (gammeSelect) gammeSelect.focus();
          return;
        }
        
        if (!commissionInput || !commissionInput.value) {
          alert(`La ligne ${index + 1} n'a pas de commission valide. Veuillez sélectionner une gamme.`);
          hasErrors = true;
          if (gammeSelect) gammeSelect.focus();
          return;
        }
        
        validRows.push(row);
      });
      
      if (hasErrors) {
        e.preventDefault();
        return false;
      }
      
      if (validRows.length === 0) {
        e.preventDefault();
        alert('Veuillez ajouter au moins une gamme/pièce avec une quantité valide.');
        if (addSaleRowBtn) addSaleRowBtn.focus();
        return false;
      }
      
      // Si tout est valide, laisser le formulaire se soumettre normalement
      // Ne pas appeler preventDefault() ici
    });
  }
  
  // Créer la première ligne par défaut
  createSaleRow();
});
</script>
<style>
#saleRows table {
  margin-bottom: 0;
}

#saleRows table thead th {
  background-color: var(--gray-100, #f8f9fa);
  font-weight: 600;
  font-size: 0.9rem;
}

#saleRows table tbody tr:hover {
  background-color: var(--gray-50, #fafafa);
}

.row-total {
  font-size: 0.85rem;
  padding: 0.35rem 0.65rem;
}

.remove-row-btn {
  padding: 0.25rem 0.5rem;
}

.gamme-select, .quantity-input, .price-input, .commission-input {
  font-size: 0.9rem;
}

#addSaleRowBtn {
  font-size: 0.85rem;
  padding: 0.35rem 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<div class="main-content">
  <div class="page-header-hl">
    <h1 class="page-title-hl">
      <i class="fas fa-{% if sale %}edit{% else %}plus{% endif %} me-2"></i>
      {% if sale %}Modifier la Vente{% else %}Nouvelle Vente{% endif %}
    </h1>
    <a href="{{ url_for('promotion.sales_list') }}" class="btn-hl btn-hl-outline">
      <i class="fas fa-arrow-left me-2"></i>Retour
    </a>
  </div>

  <div class="card" style="max-width: 900px; margin: 0 auto;">
    <div class="card-body">
      <form method="POST">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="member_id" class="form-label">Membre <span class="text-danger">*</span></label>
            <select class="form-select" id="member_id" name="member_id" required>
              <option value="">Sélectionner un membre...</option>
              {% for member_data in members %}
              <option value="{{ member_data.member.id }}" {% if sale and sale.member_id == member_data.member.id %}selected{% endif %}>
                {{ member_data.member.full_name }}{% if member_data.member.team %} - {{ member_data.member.team.name }}{% else %} - Sans équipe{% endif %}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3 mb-3">
            <label for="transaction_type" class="form-label">Type <span class="text-danger">*</span></label>
            <select class="form-select" id="transaction_type" name="transaction_type" required>
              <option value="enlevement" {% if sale and sale.transaction_type == 'enlevement' %}selected{% elif not sale %}selected{% endif %}>Enlèvement</option>
              <option value="retour" {% if sale and sale.transaction_type == 'retour' %}selected{% endif %}>Retour</option>
            </select>
          </div>

          <div class="col-md-3 mb-3">
            <label for="sale_date" class="form-label">Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="sale_date" name="sale_date" 
                   value="{{ sale.sale_date.strftime('%Y-%m-%d') if sale else today_date }}" required>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Gammes / Pièces <span class="text-danger">*</span></label>
            <button type="button" class="btn btn-sm btn-success" id="addSaleRowBtn">
              <i class="fas fa-plus me-1"></i>Ajouter une Ligne
            </button>
          </div>
          
          <div id="saleRows" class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th style="width: 40%;">Gamme / Pièce</th>
                  <th style="width: 15%;">Quantité</th>
                  <th style="width: 15%;">Prix Unitaire</th>
                  <th style="width: 15%;">Commission/Unité</th>
                  <th style="width: 10%;">Total</th>
                  <th style="width: 5%;"></th>
                </tr>
              </thead>
              <tbody id="saleRowsBody">
                <!-- Les lignes seront ajoutées dynamiquement ici -->
              </tbody>
            </table>
          </div>
          <small class="form-text text-muted">
            Cliquez sur "Ajouter une Ligne" pour ajouter plusieurs gammes/pièces.
          </small>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <div class="alert alert-info">
              <strong>Montant Total:</strong> <span id="total_amount_display">0 GNF</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="alert alert-success">
              <strong>Commission Totale:</strong> <span id="commission_display">0 GNF</span>
            </div>
          </div>
        </div>


        <div class="mb-3">
          <label for="notes" class="form-label">Notes</label>
          <textarea class="form-control" id="notes" name="notes" rows="3">{{ sale.notes if sale else '' }}</textarea>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn-hl btn-hl-primary">
            <i class="fas fa-save me-2"></i>Enregistrer
          </button>
          <a href="{{ url_for('promotion.sales_list') }}" class="btn-hl btn-hl-outline">
            <i class="fas fa-times me-2"></i>Annuler
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

