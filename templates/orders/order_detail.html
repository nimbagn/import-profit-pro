{% extends "base_modern_complete.html" %}
{% block title %}Commande {{ order.reference }} - Import Profit Pro{% endblock %}

{% block extra_css %}
<style>
  .main-content {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin-left: 280px !important;
    margin-top: 70px !important;
    transition: margin-left 0.3s ease;
  }
  
  .page-container {
    width: 100%;
    min-height: calc(100vh - 70px);
    padding: 0;
    background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
    margin: 0;
  }
  
  /* Hero Header Moderne */
  .hero-section-order {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-light) 50%, var(--hl-orange) 100%);
    padding: var(--space-3xl) var(--space-xl);
    margin: 0;
    width: 100%;
    color: white;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  }
  
  .hero-section-order::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
    border-radius: 50%;
    animation: float 8s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-30px) rotate(5deg); }
  }
  
  .hero-content-order {
    position: relative;
    z-index: 2;
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-xl);
  }
  
  .hero-title-order {
    font-size: 2.5rem;
    font-weight: 900;
    margin-bottom: var(--space-sm);
    line-height: 1.1;
    text-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }
  
  .hero-title-order i {
    font-size: 2rem;
    opacity: 0.95;
  }
  
  .hero-subtitle-order {
    font-size: 1.1rem;
    opacity: 0.95;
    font-weight: 300;
    margin-top: var(--space-sm);
  }
  
  .hero-badge-order {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-lg);
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-full);
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-weight: 600;
    font-size: 1rem;
    margin-top: var(--space-md);
  }
  
  /* Cards Modernes */
  .content-section-order {
    max-width: 1400px;
    margin: calc(var(--space-2xl) * -1) auto var(--space-2xl) auto;
    width: calc(100% - 2 * var(--space-xl));
    position: relative;
    z-index: 10;
    animation: slideUp 0.6s ease-out;
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .card-hl {
    background: var(--white);
    border: none;
    border-radius: var(--radius-xl);
    padding: var(--space-3xl);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: var(--space-xl);
    position: relative;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card-hl:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  
  .card-hl::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--color-primary), var(--hl-blue-light), var(--hl-orange));
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  }
  
  .card-header-order {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-lg);
    border-bottom: 2px solid var(--gray-200);
  }
  
  .card-title-order {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin: 0;
  }
  
  .card-title-order i {
    color: var(--color-primary);
    font-size: 1.5rem;
  }
  
  /* Badges Status Améliorés */
  .badge-status {
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-full);
    font-size: 0.9375rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    transition: transform 0.2s ease;
  }
  
  .badge-status:hover {
    transform: scale(1.05);
  }
  
  .badge-draft { 
    background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    color: white;
  }
  .badge-pending { 
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
  }
  .badge-validated { 
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
  }
  .badge-rejected { 
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
  }
  .badge-completed { 
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-dark) 100%);
    color: white;
  }
  
  /* Info Grid Moderne */
  .info-grid-order {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-lg);
  }
  
  .info-item-order {
    padding: var(--space-lg);
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .info-item-order::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--color-primary);
    transform: scaleY(0);
    transition: transform 0.3s ease;
  }
  
  .info-item-order:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border-color: var(--color-primary);
  }
  
  .info-item-order:hover::before {
    transform: scaleY(1);
  }
  
  .info-label-order {
    font-size: 0.8125rem;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-xs);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  
  .info-value-order {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-top: var(--space-xs);
  }
  
  /* Aperçu des Clients */
  .clients-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-lg);
  }
  
  .client-preview-card {
    background: linear-gradient(135deg, var(--white) 0%, var(--bg-secondary) 100%);
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .client-preview-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-primary), var(--hl-blue-light));
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }
  
  .client-preview-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border-color: var(--color-primary);
  }
  
  .client-preview-card:hover::before {
    transform: scaleX(1);
  }
  
  .client-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--gray-200);
  }
  
  .client-preview-name {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
  }
  
  .client-preview-badge {
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }
  
  .client-preview-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-md);
  }
  
  .client-preview-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    text-align: center;
  }
  
  .client-preview-stat i {
    font-size: 1.5rem;
    margin-bottom: var(--space-xs);
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-xs);
  }
  
  .stat-value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-primary);
  }
  
  .client-preview-info {
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-top: var(--space-xs);
  }
  
  .client-preview-info i {
    font-size: 0.75rem;
    opacity: 0.7;
  }
  
  /* Clients Grid Amélioré */
  .clients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-xl);
    margin-top: var(--space-lg);
  }
  
  .client-card {
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 100%;
    box-sizing: border-box;
  }
  
  .client-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--color-primary), var(--hl-blue-light));
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }
  
  .client-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    border-color: var(--color-primary);
  }
  
  .client-card:hover::before {
    transform: scaleX(1);
  }
  
  .client-card h4 {
    margin: 0 0 var(--space-md) 0;
    color: var(--color-primary);
    font-size: 1.375rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding-bottom: var(--space-sm);
    border-bottom: 2px solid var(--gray-200);
  }
  
  .client-card h4 i {
    font-size: 1.25rem;
  }
  
  /* Table Items Améliorée */
  .table-wrapper {
    width: 100%;
    margin-top: var(--space-md);
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    border-radius: var(--radius-lg);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--gray-200);
  }
  
  .items-table {
    width: 100%;
    min-width: 600px;
    margin: 0;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    background: var(--white);
    table-layout: fixed;
  }
  
  .items-table thead {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-light) 100%);
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .items-table th {
    padding: var(--space-md) var(--space-sm);
    text-align: left;
    font-size: 0.875rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: white;
    border-bottom: none;
    white-space: nowrap;
    position: relative;
    min-width: fit-content;
  }
  
  .items-table th:first-child {
    width: 35%;
  }
  
  .items-table th:nth-child(2) {
    width: 15%;
  }
  
  .items-table th:nth-child(3) {
    width: 25%;
  }
  
  .items-table th:nth-child(4) {
    width: 25%;
  }
  
  .items-table th:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 20%;
    height: 60%;
    width: 1px;
    background: rgba(255, 255, 255, 0.3);
  }
  
  .items-table th:first-child {
    padding-left: var(--space-md);
  }
  
  .items-table th:last-child {
    padding-right: var(--space-md);
    text-align: right;
  }
  
  .items-table tbody tr {
    transition: background 0.2s ease;
  }
  
  .items-table tbody tr:hover {
    background: var(--bg-secondary);
  }
  
  .items-table td {
    padding: var(--space-md) var(--space-sm);
    border-bottom: 1px solid var(--gray-200);
    vertical-align: middle;
    font-size: 0.875rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    min-width: fit-content;
  }
  
  .items-table td:first-child {
    padding-left: var(--space-md);
    width: 35%;
  }
  
  .items-table td:first-child strong {
    display: block;
    word-break: break-word;
    line-height: 1.4;
  }
  
  .items-table td:first-child small {
    display: block;
    margin-top: var(--space-xs);
    font-size: 0.75rem;
    word-break: break-word;
  }
  
  .items-table td:last-child {
    padding-right: var(--space-md);
    text-align: right;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .items-table td:nth-child(2) {
    text-align: center;
    font-weight: 600;
    color: var(--color-primary);
    white-space: nowrap;
    width: 15%;
  }
  
  .items-table td:nth-child(3) {
    text-align: right;
    white-space: nowrap;
    width: 25%;
  }
  
  .items-table td:nth-child(4) {
    text-align: right;
    white-space: nowrap;
    width: 25%;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .items-table tfoot {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-light) 100%) !important;
    display: table-footer-group !important;
    position: relative;
    z-index: 10;
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  .items-table tfoot tr {
    display: table-row !important;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-light) 100%) !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  .items-table tfoot td {
    color: white !important;
    font-weight: 700;
    font-size: 1.125rem;
    padding: var(--space-lg) var(--space-md) !important;
    border: none !important;
    background: transparent !important;
    visibility: visible !important;
    opacity: 1 !important;
    display: table-cell !important;
  }
  
  .items-table tfoot td strong {
    color: white !important;
    font-size: 1.5rem !important;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  
  /* Force la visibilité du tfoot */
  .items-table tfoot,
  .items-table tfoot tr,
  .items-table tfoot td {
    visibility: visible !important;
    opacity: 1 !important;
    display: table-footer-group !important;
  }
  
  .items-table tfoot tr {
    display: table-row !important;
  }
  
  .items-table tfoot td {
    display: table-cell !important;
  }
  
  /* Total Commande Global */
  .order-total-card {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-light) 100%) !important;
    border-radius: var(--radius-xl);
    padding: var(--space-2xl) !important;
    color: white !important;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0, 56, 101, 0.3);
    margin: var(--space-xl) 0 0 0;
    position: relative;
    overflow: visible !important;
    width: 100% !important;
    display: flex !important;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 150px;
    z-index: 10;
  }
  
  .order-total-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }
  
  .order-total-label {
    font-size: 1rem;
    opacity: 0.9;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: var(--space-sm);
    color: white !important;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
  }
  
  .order-total-value {
    font-size: 2.5rem;
    font-weight: 900;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    position: relative;
    z-index: 2;
    color: white !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    margin-top: var(--space-md);
    line-height: 1.2;
  }
  
  /* Responsive */
  @media (max-width: 1600px) {
    .main-content {
      margin-left: 260px !important;
    }
  }
  
  @media (max-width: 1200px) {
    .main-content {
      margin-left: 240px !important;
    }
    
    .hero-title-order {
      font-size: 2rem;
    }
    
    .clients-grid {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
  }
  
  @media (max-width: 1024px) {
    .main-content {
      margin-left: 0 !important;
      padding: 1rem !important;
      margin-top: 60px !important;
    }
    
    .page-container {
      padding: 0;
    }
    
    .hero-section-order {
      padding: var(--space-2xl) 1rem;
    }
    
    .hero-title-order {
      font-size: clamp(1.5rem, 4vw, 1.75rem);
    }
    
    .content-section-order {
      width: calc(100% - 2rem);
      margin-left: 1rem;
      margin-right: 1rem;
      margin-left: var(--space-md);
      margin-right: var(--space-md);
    }
    
    .card-hl {
      padding: var(--space-xl);
    }
    
    .clients-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 768px) {
    .main-content {
      margin-left: 0 !important;
      padding: 1rem !important;
      margin-top: 0 !important;
    }
    
    .page-container {
      padding: 0;
    }
    
    .hero-section-order {
      padding: var(--space-lg) 1rem;
    }
    
    .hero-content-order {
      flex-direction: column;
      align-items: flex-start !important;
      gap: var(--space-md);
    }
    
    .hero-title-order {
      font-size: clamp(1.25rem, 5vw, 1.5rem);
    }
    
    .content-section-order {
      width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    
    .card-hl {
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .clients-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .items-table {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .items-table table {
      min-width: 600px;
      font-size: 0.875rem;
    }
    
    .btn-hl {
      width: 100%;
      margin-bottom: 0.5rem;
      min-height: 44px;
    }
    
    .hero-title-order {
      font-size: 1.5rem;
      flex-direction: column;
      align-items: flex-start;
    }
    
    .hero-subtitle-order {
      font-size: 0.875rem;
    }
    
    .hero-badge-order {
      font-size: 0.875rem;
      padding: var(--space-xs) var(--space-md);
      flex-wrap: wrap;
    }
    
    .content-section-order {
      width: 100%;
      margin: calc(var(--space-xl) * -1) 0 var(--space-xl) 0;
    }
    
    .card-hl {
      margin: 0 var(--space-md) var(--space-lg) var(--space-md);
      width: calc(100% - 2 * var(--space-md));
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
    }
    
    .info-grid-order {
      grid-template-columns: 1fr;
      gap: var(--space-md);
    }
    
    .info-item-order {
      padding: var(--space-md);
    }
    
    .clients-grid {
      grid-template-columns: 1fr;
      gap: var(--space-md);
    }
    
    .client-card-order {
      padding: var(--space-md);
      margin-bottom: var(--space-md);
    }
    
    .client-header-order {
      flex-direction: column;
      align-items: flex-start !important;
      gap: var(--space-sm);
    }
    
    .client-badge-order {
      font-size: 0.875rem;
      padding: var(--space-xs) var(--space-sm);
    }
    
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: var(--space-md) -var(--space-md);
      padding: 0 var(--space-md);
    }
    
    .items-table {
      min-width: 600px;
      font-size: 0.875rem;
    }
    
    .items-table th,
    .items-table td {
      padding: var(--space-sm) var(--space-xs);
    }
    
    .items-table tfoot {
      display: table-footer-group !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .items-table tfoot tr {
      display: table-row !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .items-table tfoot td {
      padding: var(--space-md) var(--space-xs) !important;
      font-size: 1rem !important;
      visibility: visible !important;
      opacity: 1 !important;
      display: table-cell !important;
    }
    
    .items-table tfoot td strong {
      font-size: 1.25rem !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .order-total-card {
      padding: var(--space-xl) var(--space-md) !important;
      min-height: 120px;
      margin: var(--space-lg) 0 0 0 !important;
    }
    
    .order-total-label {
      font-size: 0.875rem;
    }
    
    .order-total-value {
      font-size: 1.75rem !important;
      margin-top: var(--space-sm) !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .clients-preview-grid {
      grid-template-columns: 1fr;
    }
    
    .stat-grid-order {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
    }
    
    .stat-item-order {
      padding: var(--space-sm);
    }
    
    .stat-value {
      font-size: 1.25rem;
    }
    
    .btn-hl {
      width: 100%;
      margin-bottom: var(--space-sm);
    }
  }
  
  @media (max-width: 480px) {
    .hero-section-order {
      padding: 1rem 0.75rem;
    }
    
    .hero-title-order {
      font-size: clamp(1.1rem, 5vw, 1.25rem);
    }
    
    .hero-subtitle-order {
      font-size: clamp(0.8rem, 3vw, 0.9rem);
    }
    
    .content-section-order {
      margin-top: -1.5rem;
    }
    
    .card-hl {
      padding: 1rem;
      border-radius: 12px;
    }
    
    .order-total-value {
      font-size: clamp(1.25rem, 6vw, 1.5rem) !important;
    }
    
    .items-table {
      min-width: 500px;
      font-size: 0.8rem;
    }
    
    .stat-grid-order {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
function scrollToClient(clientId) {
  const element = document.getElementById(clientId);
  if (element) {
    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    // Ajouter un effet visuel temporaire
    element.style.transition = 'box-shadow 0.3s ease';
    element.style.boxShadow = '0 0 0 4px rgba(0, 56, 101, 0.3)';
    setTimeout(() => {
      element.style.boxShadow = '';
    }, 1000);
  }
}
</script>
{% endblock %}

{% block content %}
<div class="page-container">
  <!-- Hero Header Moderne -->
  <div class="hero-section-order">
    <div class="hero-content-order">
      <div style="flex: 1;">
        <h1 class="hero-title-order">
          <i class="fas fa-shopping-cart"></i>
          Commande {{ order.reference }}
        </h1>
        <p class="hero-subtitle-order">
          Créée le {{ order.created_at.strftime('%d/%m/%Y à %H:%M') }} par {{ order.commercial.full_name or order.commercial.username }}
          {% if current_user.role and current_user.role.code == 'commercial' and order.commercial_id == current_user.id %}
          <span style="opacity: 1; font-weight: 600;">(Votre commande)</span>
          {% endif %}
        </p>
        <div class="hero-badge-order">
          <i class="fas fa-calendar-alt"></i>
          {{ order.order_date.strftime('%d/%m/%Y') if order.order_date else '-' }}
          {% if order.region %}
          <span style="margin: 0 var(--space-sm); opacity: 0.7;">•</span>
          <i class="fas fa-map-marker-alt"></i>
          {{ order.region.name }}
          {% endif %}
        </div>
      </div>
      <div style="display: flex; flex-direction: column; align-items: flex-end; gap: var(--space-md); flex-wrap: wrap;">
        {% if order.status == 'draft' %}
        <span class="badge-status badge-draft"><i class="fas fa-edit"></i>Brouillon</span>
        {% elif order.status == 'pending_validation' %}
        <span class="badge-status badge-pending"><i class="fas fa-clock"></i>En attente de validation</span>
        {% elif order.status == 'validated' %}
        <span class="badge-status badge-validated"><i class="fas fa-check-circle"></i>Validée</span>
        {% elif order.status == 'rejected' %}
        <span class="badge-status badge-rejected"><i class="fas fa-times-circle"></i>Rejetée</span>
        {% elif order.status == 'completed' %}
        <span class="badge-status badge-completed"><i class="fas fa-check-double"></i>Complétée</span>
        {% endif %}
        {% set client_totals_preview = [] %}
        {% for client in order.clients %}
          {% if client.status != 'rejected' %}
            {% set client_total_preview = client.items|calculate_items_total %}
            {% set _ = client_totals_preview.append(client_total_preview) %}
          {% endif %}
        {% endfor %}
        {% set order_total_preview = client_totals_preview|sum %}
        <div style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); padding: var(--space-sm) var(--space-md); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.3); text-align: right;">
          <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: var(--space-xs);">Valeur totale</div>
          <div style="font-size: 1.25rem; font-weight: 700;">{{ order_total_preview|format_number(0) }} GNF</div>
        </div>
        <a href="{{ url_for('orders.orders_list') }}" style="color: white; text-decoration: none; opacity: 0.9; font-weight: 600; display: flex; align-items: center; gap: var(--space-xs); transition: opacity 0.2s ease;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
          <i class="fas fa-arrow-left"></i>Retour à la liste
        </a>
      </div>
    </div>
  </div>
  
  <!-- Contenu Principal -->
  <div class="content-section-order">

    <!-- Informations générales -->
    <div class="card-hl">
      <div class="card-header-order">
        <h3 class="card-title-order">
          <i class="fas fa-info-circle"></i>
          Informations Générales
        </h3>
      </div>
      <div class="info-grid-order">
        <div class="info-item-order">
          <div class="info-label-order">
            <i class="fas fa-user-tie"></i>
            Commercial
          </div>
          <div class="info-value-order">
            {{ order.commercial.full_name or order.commercial.username }}
          </div>
        </div>
        {% if order.region %}
        <div class="info-item-order">
          <div class="info-label-order">
            <i class="fas fa-map-marker-alt"></i>
            Région
          </div>
          <div class="info-value-order">
            {{ order.region.name }}
          </div>
        </div>
        {% endif %}
        {% if order.validator %}
        <div class="info-item-order">
          <div class="info-label-order">
            <i class="fas fa-check-circle"></i>
            Validée par
          </div>
          <div class="info-value-order">
            {{ order.validator.full_name or order.validator.username }}<br>
            <small style="font-size: 0.875rem; font-weight: 400; color: var(--text-muted);">{{ order.validated_at.strftime('%d/%m/%Y à %H:%M') if order.validated_at else '' }}</small>
          </div>
        </div>
        {% endif %}
        <div class="info-item-order">
          <div class="info-label-order">
            <i class="fas fa-users"></i>
            Nombre de clients
          </div>
          <div class="info-value-order">
            {{ order.clients|length }} client(s)
          </div>
        </div>
      </div>
      {% if order.notes %}
      <div style="margin-top: var(--space-xl); padding: var(--space-lg); background: linear-gradient(135deg, rgba(0, 56, 101, 0.05) 0%, rgba(0, 82, 165, 0.05) 100%); border-left: 4px solid var(--color-primary); border-radius: var(--radius-lg);">
        <strong style="color: var(--color-primary); display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm);">
          <i class="fas fa-sticky-note"></i>Notes générales
        </strong>
        <p style="margin: 0; color: var(--text-secondary); white-space: pre-wrap;">{{ order.notes }}</p>
      </div>
      {% endif %}
      {% if order.rejection_reason %}
      <div style="margin-top: var(--space-xl); padding: var(--space-lg); background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%); border-left: 4px solid #ef4444; border-radius: var(--radius-lg);">
        <strong style="color: #dc2626; display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm);">
          <i class="fas fa-exclamation-triangle"></i>Raison du rejet
        </strong>
        <p style="margin: 0; color: var(--text-secondary); white-space: pre-wrap;">{{ order.rejection_reason }}</p>
      </div>
      {% endif %}
    </div>

    <!-- Actions pour modifier la commande -->
    {% if can_edit %}
    <div class="card-hl" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%); border: 2px solid #3b82f6;">
      <div class="card-header-order">
        <h3 class="card-title-order" style="color: #3b82f6;">
          <i class="fas fa-edit"></i>
          Modifier la Commande
        </h3>
      </div>
      <p style="margin-bottom: var(--space-md); color: var(--text-secondary);">
        <i class="fas fa-info-circle"></i> 
        Cette commande peut être modifiée car son statut est <strong>{{ order.status }}</strong>. 
        {% if order.status == 'rejected' %}
        Après modification, elle sera remise en brouillon et pourra être soumise à nouveau à validation.
        {% elif order.status == 'pending_validation' %}
        Vous pouvez modifier cette commande avant qu'elle ne soit validée par la hiérarchie. Après modification, elle restera en attente de validation.
        {% elif order.status == 'draft' %}
        Vous pouvez modifier cette commande avant de la soumettre à validation.
        {% endif %}
      </p>
      <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
        <a href="{{ url_for('orders.order_edit', id=order.id) }}" class="btn-hl" style="background: #3b82f6; color: white; border-color: #3b82f6;">
          <i class="fas fa-edit me-2"></i>Modifier la Commande
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Actions pour la hiérarchie -->
    {% if order.status == 'pending_validation' and has_permission(current_user, 'orders.validate') %}
    <div class="card-hl" style="background: linear-gradient(135deg, rgba(0, 56, 101, 0.05) 0%, rgba(255, 102, 0, 0.05) 100%); border: 2px solid var(--color-primary);">
      <div class="card-header-order">
        <h3 class="card-title-order" style="color: var(--color-primary);">
          <i class="fas fa-check-circle"></i>
          Validation de la Commande
        </h3>
      </div>
    <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
      <form method="POST" action="{{ url_for('orders.order_validate', id=order.id) }}" style="flex: 1;">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% endif %}
        <button type="submit" class="btn-hl btn-hl-primary" style="width: 100%;">
          <i class="fas fa-check me-2"></i>Valider la Commande
        </button>
      </form>
      <form method="POST" action="{{ url_for('orders.order_reject', id=order.id) }}" style="flex: 1;" id="rejectForm">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% endif %}
        <div style="display: flex; gap: var(--space-sm);">
          <input type="text" name="rejection_reason" placeholder="Raison du rejet..." required 
                 class="form-hl-input" style="flex: 1;">
          <button type="submit" class="btn-hl" style="background: #ef4444; color: white; border-color: #ef4444;">
            <i class="fas fa-times me-2"></i>Rejeter
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

    <!-- Actions pour le magasinier -->
    {% if order.status == 'validated' and has_permission(current_user, 'outgoings.create') %}
    <div class="card-hl" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border: 2px solid #10b981;">
      <div class="card-header-order">
        <h3 class="card-title-order" style="color: #059669;">
          <i class="fas fa-box-open"></i>
          Générer les Bons de Sortie
        </h3>
      </div>
    <form method="POST" action="{{ url_for('orders.order_generate_outgoing', id=order.id) }}">
      {% if csrf_token %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      {% endif %}
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-md);">
        <div class="form-group">
          <label class="form-hl-label">Dépôt source</label>
          <select name="depot_id" class="form-hl-select">
            <option value="">Sélectionner un dépôt</option>
            {% for depot in depots if depots %}
            <option value="{{ depot.id }}">{{ depot.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label class="form-hl-label">Véhicule source</label>
          <select name="vehicle_id" class="form-hl-select">
            <option value="">Sélectionner un véhicule</option>
            {% for vehicle in vehicles if vehicles %}
            <option value="{{ vehicle.id }}">{{ vehicle.plate_number }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <button type="submit" class="btn-hl" style="background: #10b981; color: white; border-color: #10b981; width: 100%;">
        <i class="fas fa-file-export me-2"></i>Générer les Bons de Sortie pour tous les Clients
      </button>
      <p style="margin-top: var(--space-sm); color: var(--text-muted); font-size: 0.875rem;">
        <i class="fas fa-info-circle"></i> Un bon de sortie sera créé pour chaque client de la commande.
      </p>
    </form>
  </div>
  {% endif %}

    <!-- Confirmation de Vente par Superviseur -->
    {% if order.status == 'validated' and has_permission(current_user, 'sales.confirm') %}
      {% if order.sale_confirmed %}
      <div class="card-hl" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border: 2px solid #10b981;">
        <div class="card-header-order">
          <h3 class="card-title-order" style="color: #059669;">
            <i class="fas fa-check-double"></i>
            Vente Confirmée
          </h3>
        </div>
        <div style="padding: var(--space-lg);">
          <p style="margin-bottom: var(--space-md); color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i> 
            Cette commande a été confirmée comme vente le <strong>{{ order.sale_confirmed_at.strftime('%d/%m/%Y à %H:%M') if order.sale_confirmed_at else '' }}</strong>
            {% if order.sale_confirmed_by %}
            par <strong>{{ order.sale_confirmed_by.full_name or order.sale_confirmed_by.username }}</strong>.
            {% endif %}
          </p>
          {% set confirmed_sales_list = [] %}
          {% if order.sale_confirmed %}
            {% for sale in order.confirmed_sale %}
              {% if sale.status == 'confirmed' %}
                {% set _ = confirmed_sales_list.append(sale) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if confirmed_sales_list %}
          <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
            <a href="{{ url_for('sales_confirmation.sale_detail', id=confirmed_sales_list[0].id) }}" class="btn-hl" style="background: #10b981; color: white; border-color: #10b981;">
              <i class="fas fa-eye me-2"></i>Voir les Détails de la Vente
            </a>
            {% if confirmed_sales_list|length > 1 %}
            <a href="{{ url_for('sales_confirmation.confirmed_sales') }}?order_id={{ order.id }}" class="btn-hl btn-hl-outline">
              <i class="fas fa-list me-2"></i>Voir toutes les ventes ({{ confirmed_sales_list|length }})
            </a>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="card-hl" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%); border: 2px solid #3b82f6;">
        <div class="card-header-order">
          <h3 class="card-title-order" style="color: #3b82f6;">
            <i class="fas fa-check-circle"></i>
            Confirmation de Vente
          </h3>
        </div>
        <p style="margin-bottom: var(--space-md); color: var(--text-secondary); padding: 0 var(--space-lg);">
          <i class="fas fa-info-circle"></i> 
          Cette commande est validée et prête pour confirmation de vente. 
          Veuillez saisir les informations de la facture manuelle réalisée par le commercial.
        </p>
        <div style="padding: 0 var(--space-lg) var(--space-lg);">
          <a href="{{ url_for('sales_confirmation.confirm_sale', order_id=order.id) }}" class="btn-hl" style="background: #3b82f6; color: white; border-color: #3b82f6; width: 100%;">
            <i class="fas fa-check me-2"></i>Confirmer la Vente
          </a>
        </div>
      </div>
      {% endif %}
    {% endif %}

    <!-- Aperçu des Clients -->
    <div class="card-hl">
      <div class="card-header-order">
        <h3 class="card-title-order">
          <i class="fas fa-eye"></i>
          Aperçu des Commandes Clients ({{ order.clients|length }} client(s))
        </h3>
      </div>
      
      <div class="clients-preview-grid">
        {% for client in order.clients %}
        {% set client_total = client.items|calculate_items_total %}
        {% set items_count = client.items|length %}
        <div class="client-preview-card" onclick="scrollToClient('client-{{ loop.index }}')" style="cursor: pointer;">
          <div class="client-preview-header">
            <div class="client-preview-name">
              <i class="fas fa-user" style="color: var(--color-primary); margin-right: var(--space-xs);"></i>
              <strong>{{ client.client_name }}</strong>
            </div>
            {% if client.payment_type == 'cash' %}
            <span class="client-preview-badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <i class="fas fa-money-bill-wave"></i>Comptant
            </span>
            {% elif client.payment_type == 'credit' %}
            <span class="client-preview-badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
              <i class="fas fa-credit-card"></i>Crédit
            </span>
            {% endif %}
          </div>
          <div class="client-preview-stats">
            <div class="client-preview-stat">
              <i class="fas fa-box" style="color: var(--color-primary);"></i>
              <span class="stat-label">Articles</span>
              <span class="stat-value">{{ items_count }}</span>
            </div>
            <div class="client-preview-stat">
              <i class="fas fa-calculator" style="color: var(--hl-orange);"></i>
              <span class="stat-label">Total</span>
              <span class="stat-value">{{ client_total|format_number(0) if client_total else '0' }} GNF</span>
            </div>
          </div>
          {% if client.client_phone %}
          <div class="client-preview-info">
            <i class="fas fa-phone"></i>{{ client.client_phone }}
          </div>
          {% endif %}
          {% if client.payment_due_date %}
          <div class="client-preview-info" style="color: #f59e0b;">
            <i class="fas fa-calendar-alt"></i>Échéance: {{ client.payment_due_date.strftime('%d/%m/%Y') }}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Clients et Articles -->
    <div class="card-hl">
      <div class="card-header-order">
        <h3 class="card-title-order">
          <i class="fas fa-users"></i>
          Détail des Commandes Clients ({{ order.clients|length }} client(s))
        </h3>
      </div>
    
    <div class="clients-grid" style="margin-bottom: var(--space-xl);">
      {% for client in order.clients %}
      <div 
        class="client-card" 
        id="client-{{ loop.index }}"
        {% if client.status == 'rejected' %}
          style="opacity: 0.7; border-color: #ef4444; background: linear-gradient(135deg, rgba(239,68,68,0.05) 0%, rgba(220,38,38,0.05) 100%);"
        {% elif client.status == 'approved' %}
          style="border-color: #10b981; background: linear-gradient(135deg, rgba(16,185,129,0.05) 0%, rgba(5,150,105,0.05) 100%);"
        {% endif %}
      >
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--gray-200); flex-wrap: wrap; gap: var(--space-sm);">
          <div style="flex: 1; min-width: 200px;">
            <h4 style="margin: 0; display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap;">
              <i class="fas fa-user me-2"></i>{{ client.client_name }}
              {% if client.status == 'rejected' %}
              <span class="badge-status" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 0.75rem; padding: 0.25rem 0.75rem;">
                <i class="fas fa-times-circle"></i>Rejeté
              </span>
              {% elif client.status == 'approved' %}
              <span class="badge-status" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 0.75rem; padding: 0.25rem 0.75rem;">
                <i class="fas fa-check-circle"></i>Approuvé
              </span>
              {% else %}
              <span class="badge-status" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 0.75rem; padding: 0.25rem 0.75rem;">
                <i class="fas fa-clock"></i>En attente
              </span>
              {% endif %}
            </h4>
          </div>
          {% set client_card_total = client.items|calculate_items_total %}
          {% if client.status != 'rejected' %}
          <div style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-light) 100%); color: white; padding: var(--space-sm) var(--space-lg); border-radius: var(--radius-full); font-weight: 700; font-size: 1.125rem; box-shadow: 0 4px 12px rgba(0, 56, 101, 0.2); white-space: nowrap; display: inline-flex; align-items: center;">
            <i class="fas fa-calculator me-2"></i>
            <span>{{ client_card_total|format_number(0) }} GNF</span>
          </div>
          {% else %}
          <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: var(--space-sm) var(--space-lg); border-radius: var(--radius-full); font-weight: 700; font-size: 1.125rem; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); text-decoration: line-through; white-space: nowrap; display: inline-flex; align-items: center;">
            <i class="fas fa-ban me-2"></i>
            <span>{{ client_card_total|format_number(0) }} GNF</span>
          </div>
          {% endif %}
        </div>
        
        <!-- Raison du rejet si rejeté -->
        {% if client.status == 'rejected' and client.rejection_reason %}
        <div style="margin-bottom: var(--space-md); padding: var(--space-md); background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%); border-left: 4px solid #ef4444; border-radius: var(--radius-md);">
          <strong style="color: #dc2626; display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm); font-size: 0.875rem;">
            <i class="fas fa-exclamation-triangle"></i>Raison du rejet
          </strong>
          <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem; white-space: pre-wrap;">{{ client.rejection_reason }}</p>
          {% if client.rejected_by %}
          <p style="margin: var(--space-xs) 0 0 0; color: var(--text-muted); font-size: 0.75rem;">
            <i class="fas fa-user"></i> Rejeté par {{ client.rejected_by.full_name or client.rejected_by.username }}
            {% if client.rejected_at %}
            le {{ client.rejected_at.strftime('%d/%m/%Y à %H:%M') }}
            {% endif %}
          </p>
          {% endif %}
        </div>
        {% endif %}
        
        <!-- Actions pour rejeter/approuver un client -->
        {% if order.status in ('pending_validation', 'validated') and has_permission(current_user, 'orders.validate') %}
        <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 2px solid var(--gray-200);">
          {% if client.status != 'rejected' %}
          <form method="POST" action="{{ url_for('orders.client_reject', order_id=order.id, client_id=client.id) }}" style="display: flex; gap: var(--space-sm); flex-wrap: wrap;">
            {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            {% endif %}
            <input type="text" name="rejection_reason" placeholder="Raison du rejet du client..." required 
                   class="form-hl-input" style="flex: 1; min-width: 200px;">
            <button type="submit" class="btn-hl" style="background: #ef4444; color: white; border-color: #ef4444; white-space: nowrap;">
              <i class="fas fa-times me-2"></i>Rejeter ce client
            </button>
          </form>
          {% else %}
          <form method="POST" action="{{ url_for('orders.client_approve', order_id=order.id, client_id=client.id) }}">
            {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            {% endif %}
            <button type="submit" class="btn-hl" style="background: #10b981; color: white; border-color: #10b981; width: 100%;">
              <i class="fas fa-check me-2"></i>Approuver ce client
            </button>
          </form>
          {% endif %}
        </div>
        {% endif %}
        {% if client.client_phone %}
        <p style="margin: 0 0 var(--space-sm) 0; color: var(--text-muted);">
          <i class="fas fa-phone me-2"></i>{{ client.client_phone }}
        </p>
        {% endif %}
        {% if client.client_address %}
        <p style="margin: 0 0 var(--space-sm) 0; color: var(--text-muted);">
          <i class="fas fa-map-marker-alt me-2"></i>{{ client.client_address }}
        </p>
        {% endif %}
        
        <!-- Type de paiement et échéance -->
        <div style="margin: var(--space-md) 0; padding: var(--space-md); background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
          {% if client.payment_type == 'cash' %}
          <span class="badge-status" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-right: var(--space-sm); font-size: 0.875rem; padding: 0.5rem 1rem;">
            <i class="fas fa-money-bill-wave"></i>Comptant
          </span>
          {% elif client.payment_type == 'credit' %}
          <span class="badge-status" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; margin-right: var(--space-sm); font-size: 0.875rem; padding: 0.5rem 1rem;">
            <i class="fas fa-credit-card"></i>Crédit
          </span>
          {% if client.payment_due_date %}
          <span style="color: var(--text-secondary); font-size: 0.875rem; font-weight: 600; display: inline-flex; align-items: center; gap: var(--space-xs);">
            <i class="fas fa-calendar-alt"></i>Échéance: {{ client.payment_due_date.strftime('%d/%m/%Y') }}
          </span>
          {% endif %}
          {% endif %}
        </div>
        
        <!-- Commentaires et observations -->
        {% if client.comments %}
        <div style="margin: var(--space-md) 0; padding: var(--space-md); background: linear-gradient(135deg, rgba(0, 56, 101, 0.08) 0%, rgba(0, 82, 165, 0.05) 100%); border-left: 4px solid var(--color-primary); border-radius: var(--radius-md); box-shadow: 0 2px 8px rgba(0, 56, 101, 0.1);">
          <strong style="color: var(--color-primary); font-size: 0.9375rem; display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm); font-weight: 700;">
            <i class="fas fa-comment-dots"></i>Commentaires
          </strong>
          <p style="margin: 0; color: var(--text-secondary); font-size: 0.9375rem; white-space: pre-wrap; line-height: 1.6;">{{ client.comments }}</p>
        </div>
        {% endif %}
        
        {% if client.notes %}
        <div style="margin: var(--space-md) 0; padding: var(--space-md); background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
          <strong style="color: var(--text-muted); font-size: 0.9375rem; display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-sm); font-weight: 600;">
            <i class="fas fa-sticky-note"></i>Notes
          </strong>
          <p style="margin: 0; color: var(--text-secondary); font-size: 0.9375rem; white-space: pre-wrap; line-height: 1.6;">{{ client.notes }}</p>
        </div>
        {% endif %}
        
        {% if client.items %}
        <div class="table-wrapper">
          <table class="items-table">
            <thead>
              <tr>
                <th>
                  <i class="fas fa-box me-2" style="opacity: 0.9;"></i>Article
                </th>
                <th style="text-align: center;">
                  <i class="fas fa-hashtag me-2" style="opacity: 0.9;"></i>Quantité
                </th>
                <th style="text-align: right;">
                  <i class="fas fa-tag me-2" style="opacity: 0.9;"></i>Prix unit.
                </th>
                <th style="text-align: right;">
                  <i class="fas fa-calculator me-2" style="opacity: 0.9;"></i>Total
                </th>
              </tr>
            </thead>
            <tbody>
              {% for item in client.items %}
              <tr>
                <td>
                  <strong>{{ item.stock_item.name }}</strong>
                  <small style="color: var(--text-muted);">{{ item.stock_item.sku or 'N/A' }}</small>
                </td>
                <td>{{ item.quantity|format_number(0) if item.quantity is not none else '0' }}</td>
                <td>{{ item.unit_price_gnf|format_number(0) if item.unit_price_gnf is not none else '0' }} GNF</td>
                <td><strong>{% if item.unit_price_gnf is not none and item.quantity is not none %}{{ ((item.quantity|float) * (item.unit_price_gnf|float))|format_number(0) }} GNF{% else %}0 GNF{% endif %}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot style="display: table-footer-group !important; visibility: visible !important; opacity: 1 !important;">
              <tr style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--hl-blue-light) 100%) !important; display: table-row !important; visibility: visible !important; opacity: 1 !important;">
                <td colspan="3" style="font-weight: 700; font-size: 1.125rem; padding: var(--space-xl) var(--space-md); color: white !important; border: none; text-transform: uppercase; letter-spacing: 0.5px; visibility: visible !important; opacity: 1 !important; display: table-cell !important;">
                  <i class="fas fa-calculator me-2"></i>Total
                </td>
                <td style="text-align: right; color: white !important; padding: var(--space-xl) var(--space-md); border: none; visibility: visible !important; opacity: 1 !important; display: table-cell !important;">
                  {% set client_total = client.items|calculate_items_total %}
                  <strong style="font-size: 1.75rem; color: white !important; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); display: inline-block; visibility: visible !important; opacity: 1 !important;">{{ client_total|format_number(0) }} GNF</strong>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
        {% endif %}
        
        {% if client.notes %}
        <div style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm); font-size: 0.875rem;">
          <strong>Notes:</strong> {{ client.notes }}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    </div>
    
    <!-- Total Global de la Commande (excluant les clients rejetés) -->
    {% set client_totals = [] %}
    {% for client in order.clients %}
      {% if client.status != 'rejected' %}
        {% set client_total_for_order = client.items|calculate_items_total %}
        {% set _ = client_totals.append(client_total_for_order) %}
      {% endif %}
    {% endfor %}
    {% set order_total = client_totals|sum %}
    
    <div class="card-hl" style="margin-top: var(--space-xl); padding: 0; background: transparent; border: none;">
      <div class="order-total-card" style="margin: 0; border-radius: var(--radius-xl); width: 100%;">
        <div class="order-total-label" style="display: flex; align-items: center; justify-content: center; gap: var(--space-sm);">
          <i class="fas fa-calculator" style="font-size: 1.5rem;"></i>
          <span>Total de la Commande</span>
        </div>
        <div class="order-total-value" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
          {{ order_total|format_number(0) }} GNF
        </div>
        {% if order.clients|length > 0 %}
        <div style="margin-top: var(--space-md); font-size: 0.875rem; opacity: 0.9; display: flex; align-items: center; justify-content: center; gap: var(--space-xs);">
          <i class="fas fa-users"></i>
          <span>{{ order.clients|length }} client(s)</span>
          <span style="margin: 0 var(--space-xs);">•</span>
          <i class="fas fa-box"></i>
          <span>
            {% set total_items = 0 %}
            {% for client in order.clients %}
              {% for item in client.items %}
                {% if item.quantity is not none %}
                  {% set total_items = total_items + (item.quantity|int) %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {{ total_items }} article(s)
          </span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

