{% extends "base_modern_complete.html" %}
{% block title %}Tableaux de Bord Analytiques - Import Profit Pro{% endblock %}

{% block extra_css %}
<style>
  .main-content {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin-left: 280px !important;
    margin-top: 70px !important;
  }
  
  .page-container {
    width: 100%;
    min-height: calc(100vh - 70px);
    padding: var(--space-xl);
    background: var(--bg-secondary);
    box-sizing: border-box;
  }
  
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    flex-wrap: wrap;
    gap: var(--space-md);
  }
  
  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    flex: 1;
    min-width: 200px;
  }
  
  .period-selector {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
    flex-wrap: wrap;
  }
  
  .period-btn {
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--gray-300);
    background: var(--white);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-normal);
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-secondary);
    white-space: nowrap;
  }
  
  .period-btn:hover {
    background: var(--gray-50);
    border-color: var(--color-primary);
  }
  
  .period-btn.active {
    background: var(--color-primary);
    color: var(--white);
    border-color: var(--color-primary);
  }
  
  .kpis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }
  
  @media (max-width: 1200px) {
    .kpis-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
  }
  
  @media (max-width: 768px) {
    .kpis-grid {
      grid-template-columns: 1fr;
      gap: var(--space-sm);
    }
  }
  
  .kpi-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-lg) var(--space-md);
    box-shadow: var(--shadow-sm);
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    min-width: 0;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }
  
  @media (max-width: 768px) {
    .kpi-card {
      padding: var(--space-md);
    }
  }
  
  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--color-primary);
  }
  
  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  .kpi-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }
  
  .kpi-card-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .kpi-card-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary-light);
    color: var(--color-primary);
  }
  
  .kpi-card-value {
    font-size: clamp(1rem, 3vw, 1.9rem);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: clip;
    word-break: keep-all;
    overflow-wrap: normal;
    line-height: 1.2;
    min-width: 0;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    display: block;
  }
  
  @media (max-width: 1400px) {
    .kpi-card-value {
      font-size: clamp(1rem, 3vw, 1.8rem);
    }
  }
  
  @media (max-width: 1200px) {
    .kpi-card-value {
      font-size: clamp(0.95rem, 2.8vw, 1.6rem);
    }
  }
  
  @media (max-width: 768px) {
    .kpi-card-value {
      font-size: clamp(0.9rem, 2.5vw, 1.4rem);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: clip;
    }
  }
  
  @media (max-width: 480px) {
    .kpi-card-value {
      font-size: clamp(0.85rem, 2.2vw, 1.2rem);
    }
  }
  
  .kpi-card-change {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.85rem;
    font-weight: 500;
    flex-wrap: wrap;
  }
  
  .kpi-card-change.positive {
    color: var(--color-success);
  }
  
  .kpi-card-change.negative {
    color: var(--color-danger);
  }
  
  .kpi-card-change.info {
    color: var(--color-info);
  }
  
  .kpi-card-subtitle {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: var(--space-xs);
  }
  
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-xl);
    margin-bottom: var(--space-xl);
  }
  
  .chart-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    box-shadow: var(--shadow-sm);
    min-width: 0;
    overflow: hidden;
  }
  
  .chart-card-header {
    margin-bottom: var(--space-lg);
  }
  
  .chart-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }
  
  .chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    min-height: 250px;
  }
  
  .alerts-section {
    margin-bottom: var(--space-xl);
  }
  
  .alerts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }
  
  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }
  
  .alert-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-md);
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--gray-300);
    transition: var(--transition-normal);
  }
  
  .alert-card:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-md);
  }
  
  .alert-card.error {
    border-left-color: var(--color-danger);
    background: #fef2f2;
  }
  
  .alert-card.warning {
    border-left-color: var(--color-warning);
    background: #fffbeb;
  }
  
  .alert-card.info {
    border-left-color: var(--color-info);
    background: #eff6ff;
  }
  
  .alert-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
    flex-wrap: wrap;
    gap: var(--space-sm);
  }
  
  .alert-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex: 1;
    min-width: 200px;
  }
  
  .alert-message {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0;
    word-break: break-word;
    overflow-wrap: break-word;
  }
  
  .alert-time {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    white-space: nowrap;
  }
  
  .empty-state {
    text-align: center;
    padding: var(--space-xxl);
    color: var(--text-secondary);
  }
  
  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: var(--space-md);
    opacity: 0.5;
  }
  
  /* Responsive Design */
  @media (max-width: 1200px) {
    .charts-grid {
      grid-template-columns: 1fr;
    }
    
    .kpis-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
  }
  
  @media (max-width: 768px) {
    .main-content {
      margin-left: 0 !important;
      margin-top: 60px !important;
    }
    
    .page-container {
      padding: var(--space-md);
    }
    
    .page-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .page-title {
      font-size: 1.5rem;
      width: 100%;
    }
    
    .period-selector {
      width: 100%;
      justify-content: flex-start;
    }
    
    .period-btn {
      font-size: 0.85rem;
      padding: var(--space-xs) var(--space-sm);
    }
    
    .charts-grid {
      grid-template-columns: 1fr;
      gap: var(--space-md);
    }
    
    .chart-card {
      padding: var(--space-md);
    }
    
    .chart-container {
      height: 250px;
      min-height: 200px;
    }
    
    .kpis-grid {
      grid-template-columns: 1fr;
      gap: var(--space-sm);
    }
    
    .kpi-card {
      padding: var(--space-md);
    }
    
    .kpi-card-value {
      font-size: 2rem;
    }
    
    .kpi-card-icon {
      width: 35px;
      height: 35px;
    }
    
    .section-title {
      font-size: 1.25rem;
    }
    
    .alert-card {
      padding: var(--space-md);
    }
    
    .alert-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .alert-title {
      width: 100%;
    }
    
    .alert-time {
      width: 100%;
    }
  }
  
  @media (max-width: 480px) {
    .page-container {
      padding: var(--space-sm);
    }
    
    .page-title {
      font-size: 1.25rem;
    }
    
    .period-selector {
      gap: var(--space-xs);
    }
    
    .period-btn {
      font-size: 0.8rem;
      padding: 6px 10px;
    }
    
    .kpi-card-value {
      font-size: 1.75rem;
    }
    
    .chart-container {
      height: 200px;
      min-height: 180px;
    }
    
    .chart-card-title {
      font-size: 1.1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">ðŸ“Š Tableaux de Bord Analytiques</h1>
      {% if user_region_name %}
      <div style="margin-top: var(--space-xs); font-size: 0.9rem; color: var(--text-secondary);">
        <i class="fas fa-map-marker-alt me-2"></i>RÃ©gion : {{ user_region_name }}
      </div>
      {% elif current_user.role and current_user.role.code in ['admin', 'superadmin'] %}
      <div style="margin-top: var(--space-xs); font-size: 0.9rem; color: var(--text-secondary);">
        <i class="fas fa-shield-alt me-2"></i>Administrateur - Vue globale
      </div>
      {% endif %}
    </div>
    <div class="period-selector">
      <button class="period-btn {% if period == 'today' %}active{% endif %}" onclick="changePeriod('today')">Aujourd'hui</button>
      <button class="period-btn {% if period == 'week' %}active{% endif %}" onclick="changePeriod('week')">Semaine</button>
      <button class="period-btn {% if period == 'month' %}active{% endif %}" onclick="changePeriod('month')">Mois</button>
      <button class="period-btn {% if period == 'quarter' %}active{% endif %}" onclick="changePeriod('quarter')">Trimestre</button>
      <button class="period-btn {% if period == 'year' %}active{% endif %}" onclick="changePeriod('year')">AnnÃ©e</button>
    </div>
  </div>
  
  <!-- KPIs Cards -->
  <div class="kpis-grid">
    <!-- Simulations KPIs -->
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">Simulations</span>
        <div class="kpi-card-icon">
          <i class="fas fa-calculator"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:,.0f}".format(simulation_kpis.total_simulations) }}</div>
      <div class="kpi-card-change {% if prev_simulation_kpis.total_simulations > 0 and simulation_kpis.total_simulations >= prev_simulation_kpis.total_simulations %}positive{% elif prev_simulation_kpis.total_simulations > 0 %}negative{% else %}info{% endif %}">
        {% if prev_simulation_kpis.total_simulations > 0 %}
        <i class="fas fa-arrow-{% if simulation_kpis.total_simulations >= prev_simulation_kpis.total_simulations %}up{% else %}down{% endif %}"></i>
        <span>{{ "{:+.0f}".format(simulation_kpis.total_simulations - prev_simulation_kpis.total_simulations) }}</span>
        {% else %}
        <i class="fas fa-info-circle"></i>
        <span>Nouveau</span>
        {% endif %}
      </div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">Marge Totale</span>
        <div class="kpi-card-icon">
          <i class="fas fa-chart-line"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:,.0f}".format(simulation_kpis.total_margin) }} GNF</div>
      <div class="kpi-card-change {% if prev_simulation_kpis.total_margin > 0 and simulation_kpis.total_margin >= prev_simulation_kpis.total_margin %}positive{% elif prev_simulation_kpis.total_margin > 0 %}negative{% else %}info{% endif %}">
        {% if prev_simulation_kpis.total_margin > 0 %}
        <i class="fas fa-arrow-{% if simulation_kpis.total_margin >= prev_simulation_kpis.total_margin %}up{% else %}down{% endif %}"></i>
        <span>{{ "{:+,.0f}".format(simulation_kpis.total_margin - prev_simulation_kpis.total_margin) }} GNF</span>
        {% else %}
        <i class="fas fa-info-circle"></i>
        <span>Nouveau</span>
        {% endif %}
      </div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">Taux de Marge</span>
        <div class="kpi-card-icon">
          <i class="fas fa-percentage"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:.2f}".format(simulation_kpis.margin_percentage) }}%</div>
      <div class="kpi-card-change {% if prev_simulation_kpis.margin_percentage > 0 and simulation_kpis.margin_percentage >= prev_simulation_kpis.margin_percentage %}positive{% elif prev_simulation_kpis.margin_percentage > 0 %}negative{% else %}info{% endif %}">
        {% if prev_simulation_kpis.margin_percentage > 0 %}
        <i class="fas fa-arrow-{% if simulation_kpis.margin_percentage >= prev_simulation_kpis.margin_percentage %}up{% else %}down{% endif %}"></i>
        <span>{{ "{:+.2f}".format(simulation_kpis.margin_percentage - prev_simulation_kpis.margin_percentage) }}%</span>
        {% else %}
        <i class="fas fa-info-circle"></i>
        <span>Nouveau</span>
        {% endif %}
      </div>
    </div>
    
    <!-- PrÃ©visions KPIs -->
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">PrÃ©visions</span>
        <div class="kpi-card-icon">
          <i class="fas fa-chart-bar"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:,.0f}".format(forecast_kpis.total_forecasts) }}</div>
      <div class="kpi-card-change {% if prev_forecast_kpis.total_forecasts > 0 and forecast_kpis.total_forecasts >= prev_forecast_kpis.total_forecasts %}positive{% elif prev_forecast_kpis.total_forecasts > 0 %}negative{% else %}info{% endif %}">
        {% if prev_forecast_kpis.total_forecasts > 0 %}
        <i class="fas fa-arrow-{% if forecast_kpis.total_forecasts >= prev_forecast_kpis.total_forecasts %}up{% else %}down{% endif %}"></i>
        <span>{{ "{:+.0f}".format(forecast_kpis.total_forecasts - prev_forecast_kpis.total_forecasts) }}</span>
        {% else %}
        <i class="fas fa-info-circle"></i>
        <span>Nouveau</span>
        {% endif %}
      </div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">PrÃ©cision</span>
        <div class="kpi-card-icon">
          <i class="fas fa-bullseye"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:.2f}".format(forecast_kpis.accuracy) }}%</div>
      <div class="kpi-card-change {% if prev_forecast_kpis.accuracy > 0 and forecast_kpis.accuracy >= prev_forecast_kpis.accuracy %}positive{% elif prev_forecast_kpis.accuracy > 0 %}negative{% else %}info{% endif %}">
        {% if prev_forecast_kpis.accuracy > 0 %}
        <i class="fas fa-arrow-{% if forecast_kpis.accuracy >= prev_forecast_kpis.accuracy %}up{% else %}down{% endif %}"></i>
        <span>{{ "{:+.2f}".format(forecast_kpis.accuracy - prev_forecast_kpis.accuracy) }}%</span>
        {% else %}
        <i class="fas fa-info-circle"></i>
        <span>Nouveau</span>
        {% endif %}
      </div>
    </div>
    
    <!-- Stocks KPIs -->
    {% if can_view_stock_values %}
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">Valeur Stock</span>
        <div class="kpi-card-icon">
          <i class="fas fa-boxes"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:,.0f}".format(stock_kpis.total_value) }} GNF</div>
      <div class="kpi-card-change {% if prev_stock_kpis.total_value > 0 and stock_kpis.total_value >= prev_stock_kpis.total_value %}positive{% elif prev_stock_kpis.total_value > 0 %}negative{% else %}info{% endif %}">
        {% if prev_stock_kpis.total_value > 0 %}
        <i class="fas fa-arrow-{% if stock_kpis.total_value >= prev_stock_kpis.total_value %}up{% else %}down{% endif %}"></i>
        <span>{{ "{:+,.0f}".format(stock_kpis.total_value - prev_stock_kpis.total_value) }} GNF</span>
        {% else %}
        <i class="fas fa-info-circle"></i>
        <span>Nouveau</span>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">Articles en Stock Faible</span>
        <div class="kpi-card-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ stock_kpis.low_stock_items_count }}</div>
      <div class="kpi-card-change warning">
        <i class="fas fa-info-circle"></i>
        <span>Ã€ surveiller</span>
      </div>
    </div>
    
    <!-- Flotte KPIs -->
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">VÃ©hicules Actifs</span>
        <div class="kpi-card-icon">
          <i class="fas fa-truck"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ vehicle_kpis.active_vehicles }}/{{ vehicle_kpis.total_vehicles }}</div>
      <div class="kpi-card-change info">
        <i class="fas fa-info-circle"></i>
        <span>En service</span>
      </div>
    </div>
    
    <!-- Promotion KPIs -->
    {% if promotion_kpis %}
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">Ã‰quipes Promotion</span>
        <div class="kpi-card-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
          <i class="fas fa-users"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:,.0f}".format(promotion_kpis.total_teams) }}</div>
      <div class="kpi-card-subtitle">{{ "{:,.0f}".format(promotion_kpis.total_members) }} membres actifs</div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">CA Net Promotion</span>
        <div class="kpi-card-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
          <i class="fas fa-chart-line"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:,.0f}".format(promotion_kpis.ca_net) }} GNF</div>
      <div class="kpi-card-change {% if prev_promotion_kpis.ca_net > 0 and promotion_kpis.ca_net >= prev_promotion_kpis.ca_net %}positive{% elif prev_promotion_kpis.ca_net > 0 %}negative{% else %}info{% endif %}">
        {% if prev_promotion_kpis.ca_net > 0 %}
        <i class="fas fa-arrow-{% if promotion_kpis.ca_net >= prev_promotion_kpis.ca_net %}up{% else %}down{% endif %}"></i>
        <span>{{ "{:+,.0f}".format(promotion_kpis.ca_net - prev_promotion_kpis.ca_net) }} GNF</span>
        {% else %}
        <i class="fas fa-info-circle"></i>
        <span>Nouveau</span>
        {% endif %}
      </div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-card-header">
        <span class="kpi-card-title">RÃ©sultat Net</span>
        <div class="kpi-card-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
          <i class="fas fa-coins"></i>
        </div>
      </div>
      <div class="kpi-card-value">{{ "{:,.0f}".format(promotion_kpis.resultat_net) }} GNF</div>
      <div class="kpi-card-subtitle">CA Net - Commissions</div>
    </div>
    {% endif %}
  </div>
  
  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-card-header">
        <h3 class="chart-card-title">Revenus</h3>
      </div>
      <div class="chart-container">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
    
    <div class="chart-card">
      <div class="chart-card-header">
        <h3 class="chart-card-title">Marges</h3>
      </div>
      <div class="chart-container">
        <canvas id="marginChart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Alerts -->
  <div class="alerts-section">
    <div class="alerts-header">
      <h2 class="section-title">ðŸš¨ Alertes Automatiques</h2>
    </div>
    
    {% if alerts %}
      {% for alert in alerts %}
        <div class="alert-card {{ alert.severity }}">
          <div class="alert-header">
            <div class="alert-title">
              {% if alert.severity == 'error' %}
                <i class="fas fa-exclamation-circle"></i>
              {% elif alert.severity == 'warning' %}
                <i class="fas fa-exclamation-triangle"></i>
              {% else %}
                <i class="fas fa-info-circle"></i>
              {% endif %}
              {{ alert.title }}
            </div>
            <span class="alert-time">{{ alert.timestamp.strftime('%d/%m/%Y %H:%M') if alert.timestamp else '' }}</span>
          </div>
          <p class="alert-message">{{ alert.message }}</p>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <p>Aucune alerte pour le moment</p>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  let revenueChart, marginChart;
  
  function changePeriod(period) {
    window.location.href = `{{ url_for('analytics.dashboard') }}?period=${period}`;
  }
  
  async function loadCharts() {
    const period = '{{ period }}';
    
    // Charger les donnÃ©es de revenus
    const revenueResponse = await fetch(`{{ url_for('analytics.api_charts_revenue') }}?period=${period}`);
    const revenueData = await revenueResponse.json();
    
    // Charger les donnÃ©es de marges
    const marginResponse = await fetch(`{{ url_for('analytics.api_charts_margin') }}?period=${period}`);
    const marginData = await marginResponse.json();
    
    // CrÃ©er le graphique de revenus
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const isMobile = window.innerWidth < 768;
    revenueChart = new Chart(revenueCtx, {
      type: 'line',
      data: {
        labels: revenueData.labels,
        datasets: [{
          label: 'Revenus (GNF)',
          data: revenueData.data,
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        resizeDelay: 100,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              boxWidth: 12,
              padding: 10,
              font: {
                size: isMobile ? 11 : 12
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            titleFont: {
              size: isMobile ? 12 : 14
            },
            bodyFont: {
              size: isMobile ? 11 : 12
            }
          }
        },
        scales: {
          x: {
            ticks: {
              font: {
                size: isMobile ? 10 : 12
              },
              maxRotation: isMobile ? 45 : 0,
              minRotation: isMobile ? 45 : 0
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              font: {
                size: isMobile ? 10 : 12
              },
              callback: function(value) {
                if (value >= 1000000) {
                  return (value / 1000000).toFixed(1) + 'M GNF';
                } else if (value >= 1000) {
                  return (value / 1000).toFixed(0) + 'K GNF';
                }
                return new Intl.NumberFormat('fr-FR').format(value) + ' GNF';
              }
            }
          }
        }
      }
    });
    
    // CrÃ©er le graphique de marges
    const marginCtx = document.getElementById('marginChart').getContext('2d');
    marginChart = new Chart(marginCtx, {
      type: 'bar',
      data: {
        labels: marginData.labels,
        datasets: [{
          label: 'Marges (GNF)',
          data: marginData.data,
          backgroundColor: '#28a745',
          borderColor: '#28a745',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        resizeDelay: 100,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              boxWidth: 12,
              padding: 10,
              font: {
                size: isMobile ? 11 : 12
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            titleFont: {
              size: isMobile ? 12 : 14
            },
            bodyFont: {
              size: isMobile ? 11 : 12
            }
          }
        },
        scales: {
          x: {
            ticks: {
              font: {
                size: isMobile ? 10 : 12
              },
              maxRotation: isMobile ? 45 : 0,
              minRotation: isMobile ? 45 : 0
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              font: {
                size: isMobile ? 10 : 12
              },
              callback: function(value) {
                if (value >= 1000000) {
                  return (value / 1000000).toFixed(1) + 'M GNF';
                } else if (value >= 1000) {
                  return (value / 1000).toFixed(0) + 'K GNF';
                }
                return new Intl.NumberFormat('fr-FR').format(value) + ' GNF';
              }
            }
          }
        }
      }
    });
  }
  
  // Charger les graphiques au chargement de la page
  document.addEventListener('DOMContentLoaded', loadCharts);
  
  // Recharger les graphiques toutes les 5 minutes
  setInterval(loadCharts, 5 * 60 * 1000);
  
  // GÃ©rer le redimensionnement de la fenÃªtre
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (revenueChart) {
        revenueChart.resize();
      }
      if (marginChart) {
        marginChart.resize();
      }
    }, 250);
  });
</script>
{% endblock %}

