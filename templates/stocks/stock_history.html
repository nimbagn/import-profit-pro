{% extends "base_modern_complete.html" %}
{% block title %}Historique Mouvements Stock - Import Profit Pro{% endblock %}

{% block extra_css %}
<style>
  .main-content {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin-left: 280px !important;
    margin-top: 70px !important;
  }
  
  .page-container {
    width: 100%;
    min-height: calc(100vh - 70px);
    padding: var(--space-xl);
    background: var(--bg-secondary);
  }

  .filters-section {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
    box-shadow: var(--shadow-sm);
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-md);
  }

  .item-section {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
    box-shadow: var(--shadow-sm);
  }

  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 2px solid var(--gray-200);
  }

  .item-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .item-stats {
    display: flex;
    gap: var(--space-lg);
  }

  .item-stat {
    text-align: center;
  }

  .item-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .item-stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
  }

  .badge-type {
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .type-transfer { background: rgba(0, 56, 101, 0.1); color: var(--color-primary); }
  .type-reception { background: rgba(16, 185, 129, 0.1); color: var(--color-success); }
  .type-adjustment { background: rgba(245, 158, 11, 0.1); color: var(--color-warning); }
  .type-inventory { background: rgba(118, 75, 162, 0.1); color: #764ba2; }

  .movement-row {
    transition: background 0.2s, transform 0.2s;
  }

  .movement-row:hover {
    background: var(--bg-secondary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  /* Styles pour le tri */
  th {
    transition: background 0.2s;
  }
  
  th:hover {
    background: var(--bg-secondary);
  }
  
  th.sort-asc,
  th.sort-desc {
    background: var(--bg-tertiary);
  }
  
  .sort-icon {
    transition: opacity 0.2s;
  }
  
  /* Classes pour l'affichage conditionnel des champs de date */
  .custom-period-visible {
    display: block;
  }
  
  .custom-period-hidden {
    display: none;
  }
  
  /* Classes pour les couleurs de mouvement */
  .movement-positive {
    color: #22c55e;
  }
  
  .movement-negative {
    color: #ef4444;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
  <div class="page-header-hl">
    <h1 class="page-title-hl">
      <i class="fas fa-history me-2"></i>
      Historique des Mouvements de Stock
    </h1>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <h3 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
      <i class="fas fa-filter me-2"></i>Filtres
    </h3>
    <form method="GET" action="{{ url_for('stocks.stock_history') }}" class="filters-grid">
      <div>
        <label class="form-hl-label">Période</label>
        <select name="period" class="form-hl-input" onchange="this.form.submit()">
          <option value="today" {% if period == 'today' %}selected{% endif %}>Aujourd'hui</option>
          <option value="week" {% if period == 'week' %}selected{% endif %}>Cette semaine</option>
          <option value="month" {% if period == 'month' %}selected{% endif %}>Ce mois</option>
          <option value="year" {% if period == 'year' %}selected{% endif %}>Cette année</option>
          <option value="all" {% if period == 'all' %}selected{% endif %}>Toutes les périodes</option>
          <option value="custom" {% if period == 'custom' %}selected{% endif %}>Personnalisée</option>
        </select>
      </div>
      
      <div id="custom-dates" class="{% if period == 'custom' %}custom-period-visible{% else %}custom-period-hidden{% endif %}">
        <label class="form-hl-label">Date début</label>
        <input type="date" name="start_date" class="form-hl-input" value="{{ start_date }}">
      </div>
      
      <div id="custom-dates-end" class="{% if period == 'custom' %}custom-period-visible{% else %}custom-period-hidden{% endif %}">
        <label class="form-hl-label">Date fin</label>
        <input type="date" name="end_date" class="form-hl-input" value="{{ end_date }}">
      </div>
      
      <div>
        <label class="form-hl-label">Article</label>
        <select name="stock_item_id" class="form-hl-input">
          <option value="">Tous les articles</option>
          {% for item in stock_items %}
          <option value="{{ item.id }}" {% if selected_stock_item_id == item.id %}selected{% endif %}>
            {{ item.name }} ({{ item.sku }})
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div>
        <label class="form-hl-label">Type de mouvement</label>
        <select name="movement_type" class="form-hl-input">
          <option value="">Tous les types</option>
          <option value="transfer" {% if selected_movement_type == 'transfer' %}selected{% endif %}>Transfert</option>
          <option value="reception" {% if selected_movement_type == 'reception' %}selected{% endif %}>Réception</option>
          <option value="adjustment" {% if selected_movement_type == 'adjustment' %}selected{% endif %}>Ajustement</option>
          <option value="inventory" {% if selected_movement_type == 'inventory' %}selected{% endif %}>Inventaire</option>
        </select>
      </div>
      
      <div>
        <label class="form-hl-label">Dépôt</label>
        <select name="depot_id" class="form-hl-input">
          <option value="">Tous les dépôts</option>
          {% for depot in depots %}
          <option value="{{ depot.id }}" {% if selected_depot_id == depot.id %}selected{% endif %}>
            {{ depot.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div>
        <label class="form-hl-label">Véhicule</label>
        <select name="vehicle_id" class="form-hl-input">
          <option value="">Tous les véhicules</option>
          {% for vehicle in vehicles %}
          <option value="{{ vehicle.id }}" {% if selected_vehicle_id == vehicle.id %}selected{% endif %}>
            {{ vehicle.plate_number }} - {{ vehicle.brand }} {{ vehicle.model }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div style="display: flex; align-items: flex-end;">
        <button type="submit" class="btn-hl btn-hl-primary" style="width: 100%;">
          <i class="fas fa-search me-2"></i>Filtrer
        </button>
      </div>
    </form>
  </div>

  <!-- Statistiques globales -->
  <div class="card-hl" style="margin-bottom: var(--space-xl);">
    <div class="card-header-hl">
      <h3 class="card-title-hl">Statistiques Globales</h3>
    </div>
    <div style="padding: var(--space-lg); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg);">
      <div style="text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: var(--color-primary);">{{ total_movements }}</div>
        <div style="color: var(--text-secondary);">Mouvements</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: #22c55e;">+{{ "{:,.2f}".format(total_entries)|replace(',', ' ') }}</div>
        <div style="color: var(--text-secondary);">Entrées</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 2rem; font-weight: 700; color: #ef4444;">-{{ "{:,.2f}".format(total_exits)|replace(',', ' ') }}</div>
        <div style="color: var(--text-secondary);">Sorties</div>
      </div>
    </div>
  </div>

  <!-- Mouvements groupés par article -->
  {% if movements_by_item %}
    {% for item_id, data in movements_by_item.items() %}
    <div class="item-section">
      <div class="item-header">
        <div>
          <div class="item-title">
            <i class="fas fa-box me-2"></i>
            {{ data.item.name }} <small style="color: var(--text-muted);">({{ data.item.sku }})</small>
          </div>
        </div>
        <div class="item-stats">
          <div class="item-stat">
            <div class="item-stat-value" style="color: var(--text-muted); font-size: 1.25rem;">
              {{ "{:,.2f}".format(data.initial_stock)|replace(',', ' ') }}
            </div>
            <div class="item-stat-label">Stock Initial</div>
          </div>
          <div class="item-stat">
            <div class="item-stat-value" style="color: #22c55e;">+{{ "{:,.2f}".format(data.total_entries)|replace(',', ' ') }}</div>
            <div class="item-stat-label">Entrées</div>
          </div>
          <div class="item-stat">
            <div class="item-stat-value" style="color: #ef4444;">-{{ "{:,.2f}".format(data.total_exits)|replace(',', ' ') }}</div>
            <div class="item-stat-label">Sorties</div>
          </div>
          <div class="item-stat">
            <div class="item-stat-value" style="color: var(--color-primary); font-size: 1.75rem;">
              {{ "{:,.2f}".format(data.final_stock)|replace(',', ' ') }}
            </div>
            <div class="item-stat-label">Stock Final</div>
          </div>
        </div>
      </div>
      
      <div class="table-hl">
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Référence</th>
              <th>Quantité</th>
              <th>Solde Progressif</th>
              <th>Source</th>
              <th>Destination</th>
              <th>Utilisateur</th>
            </tr>
          </thead>
          <tbody>
            {% for movement in data.movements %}
            <tr class="movement-row">
              <td>{{ movement.movement_date.strftime('%d/%m/%Y %H:%M') if movement.movement_date else '-' }}</td>
              <td>
                <span class="badge-hl badge-type type-{{ movement.movement_type }}">
                  {{ movement.movement_type|title }}
                </span>
              </td>
              <td>{{ movement.reference or '-' }}</td>
              <td class="{% if movement.quantity >= 0 %}movement-positive{% else %}movement-negative{% endif %}" style="font-weight: 600; text-align: center;">
                {% if movement.quantity >= 0 %}+{% endif %}{{ "{:,.2f}".format(movement.quantity)|replace(',', ' ') }}
              </td>
              <td style="font-weight: 700; color: var(--color-primary); text-align: center;">
                {{ "{:,.2f}".format(movement.running_balance)|replace(',', ' ') }}
              </td>
              <td>
                {% if movement.from_depot %}
                  <i class="fas fa-warehouse me-1"></i>{{ movement.from_depot.name }}
                {% elif movement.from_vehicle %}
                  <i class="fas fa-truck me-1"></i>{{ movement.from_vehicle.plate_number }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if movement.to_depot %}
                  <i class="fas fa-warehouse me-1"></i>{{ movement.to_depot.name }}
                {% elif movement.to_vehicle %}
                  <i class="fas fa-truck me-1"></i>{{ movement.to_vehicle.plate_number }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ movement.user.username if movement.user else '-' }}</td>
            </tr>
            {% endfor %}
            {% if data.movements %}
            <!-- Ligne du stock final -->
            <tr style="background: var(--bg-tertiary); font-weight: 600; border-top: 2px solid var(--gray-300);">
              <td colspan="3" style="text-align: right; padding-right: var(--space-md);">
                <i class="fas fa-arrow-left me-1" style="color: var(--text-muted);"></i>
                <span style="color: var(--text-muted);">Stock Final</span>
              </td>
              <td style="text-align: center; color: var(--text-muted);">-</td>
              <td style="font-weight: 700; color: var(--color-primary); text-align: center;">
                {{ "{:,.2f}".format(data.final_stock)|replace(',', ' ') }}
              </td>
              <td colspan="3"></td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  {% else %}
  <div class="card-hl">
    <div style="text-align: center; padding: var(--space-3xl); color: var(--text-muted);">
      <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: var(--space-md); opacity: 0.3;"></i>
      <p>Aucun mouvement trouvé avec les filtres sélectionnés.</p>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Gestion des filtres de période
  const periodSelect = document.querySelector('select[name="period"]');
  const customDates = document.getElementById('custom-dates');
  const customDatesEnd = document.getElementById('custom-dates-end');
  
  if (periodSelect) {
    periodSelect.addEventListener('change', function() {
      const isCustom = this.value === 'custom';
      if (customDates) {
        customDates.classList.remove('custom-period-visible', 'custom-period-hidden');
        customDates.classList.add(isCustom ? 'custom-period-visible' : 'custom-period-hidden');
      }
      if (customDatesEnd) {
        customDatesEnd.classList.remove('custom-period-visible', 'custom-period-hidden');
        customDatesEnd.classList.add(isCustom ? 'custom-period-visible' : 'custom-period-hidden');
      }
    });
  }
  
  // Tri dynamique des tableaux
  const tables = document.querySelectorAll('.table-hl table');
  tables.forEach(function(table) {
    const thead = table.querySelector('thead');
    if (!thead) return;
    
    const headers = thead.querySelectorAll('th');
    headers.forEach(function(header, index) {
      // Ajouter un indicateur de tri
      header.style.cursor = 'pointer';
      header.style.userSelect = 'none';
      header.style.position = 'relative';
      
      // Ajouter une icône de tri
      const sortIcon = document.createElement('i');
      sortIcon.className = 'fas fa-sort sort-icon';
      sortIcon.style.marginLeft = '0.5rem';
      sortIcon.style.opacity = '0.5';
      sortIcon.style.fontSize = '0.75rem';
      header.appendChild(sortIcon);
      
      header.addEventListener('click', function() {
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr:not([style*="background"])'));
        if (rows.length === 0) return;
        
        // Déterminer le type de tri (ascendant ou descendant)
        const isAscending = !header.classList.contains('sort-asc');
        
        // Retirer les classes de tri de tous les headers
        headers.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
          const icon = h.querySelector('.sort-icon');
          if (icon) {
            icon.className = 'fas fa-sort sort-icon';
            icon.style.opacity = '0.5';
          }
        });
        
        // Ajouter la classe de tri au header actuel
        header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
        const icon = header.querySelector('.sort-icon');
        if (icon) {
          icon.className = isAscending ? 'fas fa-sort-up sort-icon' : 'fas fa-sort-down sort-icon';
          icon.style.opacity = '1';
        }
        
        // Trier les lignes
        rows.sort(function(a, b) {
          const aCell = a.cells[index];
          const bCell = b.cells[index];
          
          if (!aCell || !bCell) return 0;
          
          let aValue = aCell.textContent.trim();
          let bValue = bCell.textContent.trim();
          
          // Essayer de convertir en nombre si possible
          const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
          const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));
          
          if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? aNum - bNum : bNum - aNum;
          }
          
          // Tri alphabétique
          if (isAscending) {
            return aValue.localeCompare(bValue);
          } else {
            return bValue.localeCompare(aValue);
          }
        });
        
        // Réorganiser les lignes dans le DOM
        rows.forEach(function(row) {
          tbody.appendChild(row);
        });
      });
    });
  });
  
  // Animation au survol des lignes
  const movementRows = document.querySelectorAll('.movement-row');
  movementRows.forEach(function(row) {
    row.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.01)';
      this.style.transition = 'transform 0.2s';
    });
    row.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
    });
  });
});
</script>
{% endblock %}

