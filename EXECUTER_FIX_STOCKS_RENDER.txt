========================================
CORRIGER MODULE STOCKS SUR RENDER
========================================

üìã PROBL√àME :
Erreur "Stock insuffisant √† la source" sur Render
La route /stocks/movements/new ne fonctionne pas correctement

üîß SOLUTION :
Ex√©cuter les scripts SQL pour corriger les tables de stock

========================================
√âTAPES RAPIDES :
========================================

1. Acc√©der au Shell PostgreSQL sur Render
   Dashboard Render ‚Üí Service PostgreSQL ‚Üí Shell/Connect

2. Ex√©cuter dans l'ordre :

   a) Fix stock_movements :
   psql $DATABASE_URL < scripts/fix_stock_movements_postgresql.sql

   b) Fix depot_stocks et vehicle_stocks :
   psql $DATABASE_URL < scripts/fix_stocks_tables_postgresql.sql

   OU

   c) Migration compl√®te stocks (recommand√©) :
   psql $DATABASE_URL < scripts/migration_stocks_complete_postgresql.sql

========================================
V√âRIFICATION RAPIDE :
========================================

-- V√©rifier depot_stocks
SELECT COUNT(*) FROM depot_stocks;
SELECT depot_id, stock_item_id, quantity 
FROM depot_stocks 
WHERE quantity > 0 
LIMIT 10;

-- V√©rifier vehicle_stocks
SELECT COUNT(*) FROM vehicle_stocks;
SELECT vehicle_id, stock_item_id, quantity 
FROM vehicle_stocks 
WHERE quantity > 0 
LIMIT 10;

-- V√©rifier stock_movements
SELECT COUNT(*) FROM stock_movements;
SELECT movement_type, COUNT(*) 
FROM stock_movements 
GROUP BY movement_type;

========================================
CE QUE LES SCRIPTS CORRIGENT :
========================================

‚úÖ stock_movements :
- Type ENUM movement_type avec toutes les valeurs
- Colonne reference
- Toutes les FK (from_depot, to_depot, from_vehicle, to_vehicle)
- Tous les index

‚úÖ depot_stocks :
- Cr√©ation de la table si manquante
- FK vers depots et stock_items
- Index pour performances
- Synchronisation depuis stock_movements

‚úÖ vehicle_stocks :
- Cr√©ation de la table si manquante
- FK vers vehicles et stock_items
- Index pour performances
- Synchronisation depuis stock_movements

========================================
‚ö†Ô∏è IMPORTANT :
========================================

- Les scripts sont IDEMPOTENTS (peut √™tre ex√©cut√©s plusieurs fois)
- Faites un BACKUP avant d'ex√©cuter
- La synchronisation recalcule les stocks depuis stock_movements
- Cela corrige l'erreur "Stock insuffisant"

========================================

